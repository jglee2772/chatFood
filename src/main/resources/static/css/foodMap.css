<body>
<header>
  <h1>ğŸ± LunchBot ë§›ì§‘ ì§€ë„</h1>
  <p>AIê°€ ë‚´ ì£¼ë³€ ë§›ì§‘ì„ ì°¾ì•„ë“œë¦´ê²Œìš”</p>

  <div class="search-box">
    <input type="text" id="search-input" placeholder="ì˜ˆ: ì´ˆë°¥, ëˆê¹ŒìŠ¤, íŒŒìŠ¤íƒ€">
    <button id="search-btn">ê²€ìƒ‰</button>
  </div>
</header>

<div class="header-images">
  <img src="/img/ê¹€ì¹˜ì°Œê°œ.png" alt="ê¹€ì¹˜ì°Œê°œ">
  <img src="/img/í”¼ì.png" alt="í”¼ì">
  <img src="/img/ëˆê¹ŒìŠ¤.png" alt="ëˆê¹ŒìŠ¤">
  <img src="/img/ìŠ¤í…Œì´í¬.png" alt="ìŠ¤í…Œì´í¬">
</div>

<div class="main-wrapper">
  <div class="upper-content">
    <div id="map"></div>
    <div class="map-title">ğŸ“ ë‚´ ì£¼ë³€ ë§›ì§‘ íƒìƒ‰ ì¤‘...</div>
    <div class="map-loading" id="map-loading">ì§€ë„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    <div class="map-overlay-card">
      <img src="/img/ê¹€ì¹˜ì°Œê°œ.png" alt="ì¶”ì²œ">
      <span>AIê°€ ì¶”ì²œí•˜ëŠ” ë§›ì§‘ì„ íƒìƒ‰ ì¤‘...</span>
      <button onclick="searchPlaces('ë§›ì§‘')">ìƒˆë¡œê³ ì¹¨</button>
    </div>
  </div>

  <div class="right-side-content">
    <h3>AI ì¶”ì²œ ë§›ì§‘ TOP 3 ğŸœ</h3>
    <div id="restaurant-list"></div>
    <div id="restaurant-detail"></div>
  </div>
</div>

<script src="//dapi.kakao.com/v2/maps/sdk.js?appkey=c7620c46bc5355020067ad99447e75f3&libraries=services"></script>
<script>
let map, userLocation = null, markers = [], infowindow = new kakao.maps.InfoWindow({ zIndex: 1 });

async function getUserLocation() {
  return new Promise((resolve) => {
    if (!navigator.geolocation) {
      userLocation = { lat: 37.5665, lng: 126.9780 };
      resolve();
      return;
    }
    navigator.geolocation.getCurrentPosition(
      (pos) => {
        userLocation = { lat: pos.coords.latitude, lng: pos.coords.longitude };
        resolve();
      },
      () => {
        userLocation = { lat: 37.5665, lng: 126.9780 };
        resolve();
      }
    );
  });
}

function initMap() {
  const center = new kakao.maps.LatLng(userLocation.lat, userLocation.lng);
  const container = document.getElementById("map");
  const options = { center, level: 5 };
  map = new kakao.maps.Map(container, options);

  const marker = new kakao.maps.Marker({ position: center, map });
  const info = new kakao.maps.InfoWindow({ content: '<div style="padding:5px;font-size:12px;">ğŸ“ ë‚´ ìœ„ì¹˜</div>' });
  info.open(map, marker);

  document.getElementById("map-loading").style.display = "none";
  searchPlaces("ë§›ì§‘");
}

function searchPlaces(keyword) {
  clearMarkers();
  const ps = new kakao.maps.services.Places();
  const opt = {
    location: new kakao.maps.LatLng(userLocation.lat, userLocation.lng),
    radius: 2000,
    sort: kakao.maps.services.SortBy.DISTANCE,
  };
  ps.keywordSearch(keyword, placesSearchCB, opt);
}

function placesSearchCB(data, status) {
  if (status !== kakao.maps.services.Status.OK) {
    alert("ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  const bounds = new kakao.maps.LatLngBounds();
  data.forEach((d) => bounds.extend(new kakao.maps.LatLng(d.y, d.x)));
  map.setBounds(bounds);

  displayTop3Restaurants(data);
  data.forEach(displayMarker);
}

function displayMarker(place) {
  const marker = new kakao.maps.Marker({
    map,
    position: new kakao.maps.LatLng(place.y, place.x),
  });
  markers.push(marker);
  kakao.maps.event.addListener(marker, "click", () => {
    infowindow.setContent(`<div style="padding:8px;font-size:12px;"><strong>${place.place_name}</strong><br>${place.road_address_name || place.address_name}</div>`);
    infowindow.open(map, marker);
  });
}

function clearMarkers() {
  markers.forEach((m) => m.setMap(null));
  markers = [];
  document.getElementById("restaurant-list").innerHTML = "";
  document.getElementById("restaurant-detail").style.display = "none";
}

function displayTop3Restaurants(places) {
  const list = document.getElementById("restaurant-list");
  list.innerHTML = "";

  const top3 = places.slice(0, 3);
  top3.forEach((p, i) => {
    const card = document.createElement("div");
    card.className = "restaurant-card";
    card.innerHTML = `
      <h4>${i + 1}ìœ„. ${p.place_name}</h4>
      <p>${p.road_address_name || p.address_name}</p>
      <p class="rating">â­ ${(4 + Math.random()).toFixed(1)}</p>
    `;
    card.addEventListener("click", () => showDetail(p));
    list.appendChild(card);
  });
}

function showDetail(place) {
  const detail = document.getElementById("restaurant-detail");
  detail.style.display = "block";
  detail.innerHTML = `
    <h4>${place.place_name}</h4>
    <p>ğŸ“ ì£¼ì†Œ: ${place.road_address_name || place.address_name}</p>
    <p>ğŸ“ ì „í™”ë²ˆí˜¸: ${place.phone || "ì—†ìŒ"}</p>
    <p>ğŸ· ì¹´í…Œê³ ë¦¬: ${place.category_name || "ìŒì‹ì "}</p>
    <p>ğŸŒ ê±°ë¦¬: ì•½ ${(Math.random() * 1.5 + 0.3).toFixed(2)} km</p>
    <p>â­ í‰ì : ${(4 + Math.random()).toFixed(1)}</p>
  `;
}

window.onload = async () => {
  await getUserLocation();
  initMap();

  const searchBtn = document.getElementById("search-btn");
  const searchInput = document.getElementById("search-input");
  searchBtn.addEventListener("click", () => {
    const keyword = searchInput.value.trim();
    if (keyword) searchPlaces(keyword);
    else alert("ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!");
  });
  searchInput.addEventListener("keypress", (e) => {
    if (e.key === "Enter") {
      const keyword = searchInput.value.trim();
      if (keyword) searchPlaces(keyword);
      else alert("ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!");
    }
  });
};
</script>
</body>
</html>