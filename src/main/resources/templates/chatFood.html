<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LunchBot - 오늘 뭐 먹을까?</title>
    <link rel="stylesheet" href="/css/chatFood.css" />
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700;900&display=swap" rel="stylesheet">
</head>

<body>
<!-- 🌞 중심 빛 효과 -->
<div class="light-glow"></div>

<!-- 🏠 홈 버튼 -->
<a href="/" class="home-btn">🏠</a>

<div class="chat-wrapper">
    <div class="logo-section">
        <div class="logo-icon">🤖</div>
        <h1>LunchBot <span>오늘 뭐 먹을까?</span></h1>
    </div>

    <div class="chat-container">
        <div class="chat-left">
            <div class="chat-messages" id="chat-messages">
                <!-- 메시지는 동적으로 채워집니다 -->
            </div>
            
            <!-- 대화 옵션 영역 -->
            <div id="conversation-options" class="conversation-options"></div>

            <div class="input-area">
                <input type="text" id="message-input" placeholder="메시지를 입력하세요..." />
                <button class="send-btn" id="send-btn">전송</button>
            </div>
        </div>
        
        <!-- GPT 대화 추천 영역 - 채팅창 오른쪽 -->
        <div class="gpt-recommendation-section">
            <div class="gpt-recommendation-header">
                <h3>💬 대화 중 추천</h3>
            </div>
            <div id="gpt-recommendation-area" class="gpt-recommendation-area"></div>
        </div>
    </div>
    
    <!-- Python AI 개인화 추천 영역 - 하단 고정 -->
    <div class="python-recommendation-section">
        <div class="python-recommendation-header">
            <h3>🎯 AI 맞춤 추천</h3>
        </div>
        <div id="python-recommendation-area" class="python-recommendation-area"></div>
    </div>
</div>

<script>
    const chatMessages = document.getElementById('chat-messages');
    const messageInput = document.getElementById('message-input');
    const sendBtn = document.getElementById('send-btn');
    const gptRecommendationArea = document.getElementById('gpt-recommendation-area');
    const pythonRecommendationArea = document.getElementById('python-recommendation-area');
    const conversationOptions = document.getElementById('conversation-options');

    const API_URL = '/chat';
    const sessionId = `session_${Date.now()}`;

    // 페이지가 로드되면, 서버에 첫 인사를 요청합니다.
    // (이 함수는 아래에서 재정의됩니다)

    // 메시지를 서버로 보내고 응답을 처리하는 메인 함수
    const sendMessage = async (messageText, isInitial = false) => {
        const message = isInitial ? messageText : messageInput.value.trim();
        if (message === '' && !isInitial) return;

        if (!isInitial) {
            addMessageToChat('user', message);
            messageInput.value = '';
        }

        gptRecommendationArea.innerHTML = '';
        conversationOptions.innerHTML = '';
        showTypingIndicator();

        try {
            const payload = { message: message, sessionId: sessionId };
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
            });

            if (!response.ok) throw new Error('서버 응답 오류');

            const data = await response.json();
            hideTypingIndicator();

            addMessageToChat('bot', data.reply);

            // GPT 대화 추천은 오른쪽 영역에 표시
            if (data.recommendations && data.recommendations.length > 0) {
                console.log('GPT 추천 표시:', data.recommendations);
                displayGPTRecommendationCards(data.recommendations);
                addGPTRecommendationClickEvents(data.recommendations);
            } else {
                console.log('GPT 추천이 없음, 기본 추천 표시');
                // 기본 추천 표시
                const defaultRecommendations = [
                    { foodName: '김치찌개', priceMin: 8000, priceMax: 10000 },
                    { foodName: '비빔밥', priceMin: 9000, priceMax: 11000 },
                    { foodName: '제육볶음', priceMin: 10000, priceMax: 12000 }
                ];
                displayGPTRecommendationCards(defaultRecommendations);
                addGPTRecommendationClickEvents(defaultRecommendations);
            }

            // 대화 옵션 표시
            if (data.options && data.options.length > 0) {
                displayConversationOptionsFromResponse(data.options);
            }

        } catch (error) {
            console.error('Error:', error);
            hideTypingIndicator();
            addMessageToChat('bot', '죄송해요, 지금 서버에 문제가 생겨서 답변을 드릴 수 없어요. 😥');
        }
    };

    // GPT 대화 추천 카드 표시 함수
    const displayGPTRecommendationCards = (recommendations) => {
        gptRecommendationArea.innerHTML = '';
        recommendations.forEach(rec => {
            const foodName = rec.foodName || rec.food_name;
            if (!foodName) return;

            const card = document.createElement('div');
            card.className = 'gpt-recommendation-card';
            card.setAttribute('data-food', foodName);
            card.style.cursor = 'pointer'; // 클릭 가능함을 표시

            const priceMin = rec.priceMin || rec.price_min || 0;
            const priceMax = rec.priceMax || rec.price_max || 0;

            card.innerHTML = `
                <h4>${foodName}</h4>
                <div class="price">${priceMin.toLocaleString()}원 ~ ${priceMax.toLocaleString()}원</div>
                <div class="click-hint">클릭하여 검색</div>
            `;

            gptRecommendationArea.appendChild(card);
        });
    };
    
    // Python AI 개인화 추천 카드 표시 함수
    const displayPythonRecommendationCards = (recommendations) => {
        pythonRecommendationArea.innerHTML = '';
        
        if (!recommendations || recommendations.length === 0) {
            return;
        }
        
        recommendations.forEach((rec, index) => {
            const foodName = rec.foodName || rec.food_name;
            if (!foodName) {
                return;
            }

            const card = document.createElement('div');
            card.className = 'python-recommendation-card';
            card.setAttribute('data-food', foodName);

            let icon = '🍴';
            if(foodName.includes('국밥') || foodName.includes('비빔밥') || foodName.includes('제육')) icon = '🍚';
            if(foodName.includes('짜장') || foodName.includes('짬뽕') || foodName.includes('탕수육')) icon = '🍜';
            if(foodName.includes('초밥') || foodName.includes('라멘') || foodName.includes('돈까스')) icon = '🍣';
            if(foodName.includes('파스타') || foodName.includes('피자') || foodName.includes('스테이크')) icon = '🍕';

            const priceMin = rec.priceMin || rec.price_min || 0;
            const priceDisplay = priceMin > 0 ? `약 ${priceMin.toLocaleString()}원 ~` : '';

            card.innerHTML = `
                <div class="food-icon">${icon}</div>
                <div class="food-name">${foodName}</div>
                <div class="food-price">${priceDisplay}</div>
            `;

            card.onclick = () => {
                addMessageToChat('user', `${foodName} 좋아요!`);
                setTimeout(() => {
                    const encodedFoodName = encodeURIComponent(foodName);
                    window.location.href = `/foodMap?search=${encodedFoodName}`;
                }, 1000);
            };

            pythonRecommendationArea.appendChild(card);
        });
    };
    
    // 기존 추천 카드 UI를 동적으로 생성하는 함수 (호환성 유지)
    const displayRecommendationCards = (recommendations) => {
        recommendations.forEach(rec => {
            // foodName 또는 food_name 필드 확인
            const foodName = rec.foodName || rec.food_name;
            if (!foodName) return;

            const card = document.createElement('div');
            card.className = 'recommendation-card';

            let icon = '🍴';
            if(foodName.includes('국밥') || foodName.includes('비빔밥') || foodName.includes('제육')) icon = '🍚';
            if(foodName.includes('짜장') || foodName.includes('짬뽕') || foodName.includes('탕수육')) icon = '🍜';
            if(foodName.includes('초밥') || foodName.includes('라멘') || foodName.includes('돈까스')) icon = '🍣';
            if(foodName.includes('파스타') || foodName.includes('피자') || foodName.includes('스테이크')) icon = '🍕';

            // 가격 정보 처리
            const priceMin = rec.priceMin || rec.price_min || 0;
            const priceDisplay = priceMin > 0 ? `약 ${priceMin.toLocaleString()}원 ~` : '';

            card.innerHTML = `
                <div class="food-icon">${icon}</div>
                <div class="food-name">${foodName}</div>
                <div class="food-price">${priceDisplay}</div>
            `;

            card.onclick = () => {
                // 사용자 메시지 추가
                addMessageToChat('user', `${foodName} 좋아요!`);
                
                // 잠시 후 foodMap.html로 리다이렉트 (사용자가 메시지를 볼 수 있도록)
                setTimeout(() => {
                    const encodedFoodName = encodeURIComponent(foodName);
                    window.location.href = `/foodMap?search=${encodedFoodName}`;
                }, 1000);
            };

            pythonRecommendationArea.appendChild(card);
        });
    };

    // 서버 응답의 옵션을 표시하는 함수
    const displayConversationOptionsFromResponse = (options) => {
        conversationOptions.innerHTML = '';
        options.forEach(option => {
            const optionElement = document.createElement('div');
            optionElement.className = 'conversation-option';
            optionElement.textContent = option.text;
            optionElement.onclick = () => {
                sendMessage(option.text);
            };
            conversationOptions.appendChild(optionElement);
        });
    };

    // 대화 옵션을 표시하는 함수
    const displayConversationOptions = (recommendations) => {
        // 음식 선택 옵션들
        recommendations.forEach(rec => {
            const foodName = rec.foodName || rec.food_name;
            if (foodName) {
                const option = document.createElement('div');
                option.className = 'conversation-option food-option';
                option.textContent = foodName;
                option.onclick = () => {
                    addMessageToChat('user', `${foodName} 좋아요!`);
                    setTimeout(() => {
                        const encodedFoodName = encodeURIComponent(foodName);
                        window.location.href = `/foodMap?search=${encodedFoodName}`;
                    }, 1000);
                };
                conversationOptions.appendChild(option);
            }
        });

        // 대화 이어가기 옵션
        const continueOption = document.createElement('div');
        continueOption.className = 'conversation-option continue-option';
        continueOption.textContent = '다른 음식도 추천해주세요';
        continueOption.onclick = () => {
            sendMessage('다른 음식도 추천해주세요');
        };
        conversationOptions.appendChild(continueOption);
    };

    // 대화 메시지를 채팅창에 추가하는 함수
    const addMessageToChat = (sender, text) => {
        if (text === '__INIT__') return;
        const messageElement = document.createElement('div');
        messageElement.className = sender === 'user' ? 'user-message' : 'bot-message';
        messageElement.innerHTML = text.replace(/\n/g, '<br>');
        chatMessages.appendChild(messageElement);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    };

    // '입력 중...' 애니메이션 관련 함수들 (기존과 동일)
    const showTypingIndicator = () => {
        const typingElement = document.createElement('div');
        typingElement.className = 'bot-message bot-typing';
        typingElement.id = 'typing-indicator';
        typingElement.innerHTML = '<div class="dot"></div><div class="dot"></div><div class="dot"></div>';
        chatMessages.appendChild(typingElement);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    };

    const hideTypingIndicator = () => {
        const typingIndicator = document.getElementById('typing-indicator');
        if(typingIndicator) {
            chatMessages.removeChild(typingIndicator);
        }
    };

    // 자연스러운 대화 옵션들
    const addNaturalConversationOptions = () => {
        const naturalOptions = [
            '배고파요 😋',
            '오늘 기분이 좋아요! 😊',
            '스트레스 받았어요 😮‍💨',
            '날씨가 추워요 ❄️',
            '디저트 먹고 싶어요 🍰',
            '어떤 음식이 좋을까요? 🤔',
            '오늘 힘들었어요 😴',
            '기분이 우울해요 😢',
            '피곤해요 😩',
            '행복해요! 🎉',
            '시간이 없어요 ⏰',
            '뭔가 특별한 거 먹고 싶어요 ✨'
        ];

        naturalOptions.forEach(text => {
            const button = document.createElement('div');
            button.className = 'conversation-option';
            button.textContent = text;
            button.onclick = () => {
                sendMessage(text);
            };
            conversationOptions.appendChild(button);
        });
    };

    // 초기 대화 옵션 표시
    const showInitialOptions = () => {
        conversationOptions.innerHTML = '';
        addNaturalConversationOptions();
    };

    // 이벤트 리스너
    sendBtn.addEventListener('click', () => sendMessage());
    messageInput.addEventListener('keydown', (event) => {
        if (event.key === 'Enter') {
            sendMessage();
        }
    });

    // 초기 추천 로드
    const loadInitialRecommendations = async () => {
        try {
            const response = await fetch('/initial-recommendations');
            const data = await response.json();
            
            // AI 응답을 채팅창에 표시
            if (data.reply) {
                addMessageToChat('bot', data.reply);
            }
            
            // Python AI 개인화 추천은 하단 고정 영역에 표시
            if (data.pythonRecommendations && data.pythonRecommendations.length > 0) {
                displayPythonRecommendationCards(data.pythonRecommendations);
            }
            
            // 대화 옵션 표시
            if (data.options && data.options.length > 0) {
                displayConversationOptionsFromResponse(data.options);
            }
            
        } catch (error) {
            console.error('초기 추천 로드 실패:', error);
        }
    };
    
    // GPT 추천 음식 클릭 이벤트 추가
    const addGPTRecommendationClickEvents = (recommendations) => {
        recommendations.forEach(rec => {
            const foodName = rec.foodName || rec.food_name;
            const card = document.querySelector(`[data-food="${foodName}"]`);
            if (card) {
                card.addEventListener('click', () => {
                    console.log('GPT 추천 클릭됨:', foodName);
                    const searchUrl = `/foodMap?search=${encodeURIComponent(foodName)}`;
                    console.log('이동할 URL:', searchUrl);
                    // 음식 선택 시 foodMap으로 이동
                    window.location.href = searchUrl;
                });
            }
        });
    };
    
    
    // 페이지 로드 시 초기 추천 로드
    window.onload = async () => {
        await loadInitialRecommendations();
    };

</script>
</body>
</html>

