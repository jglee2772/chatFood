<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LunchBot - ì˜¤ëŠ˜ ë­ ë¨¹ì„ê¹Œ?</title>
    <link rel="stylesheet" href="/css/chatFood.css" />
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700;900&display=swap" rel="stylesheet">
</head>

<body>
<!-- ğŸŒ ì¤‘ì‹¬ ë¹› íš¨ê³¼ -->
<div class="light-glow"></div>

<!-- ğŸ  í™ˆ ë²„íŠ¼ -->
<a href="/" class="home-btn">ğŸ </a>

<div class="chat-wrapper">
    <div class="logo-section">
        <div class="logo-icon">ğŸ¤–</div>
        <h1>LunchBot <span>ì˜¤ëŠ˜ ë­ ë¨¹ì„ê¹Œ?</span></h1>
    </div>

    <div class="chat-container">
        <div class="chat-left">
            <div class="chat-messages" id="chat-messages">
                <!-- ë©”ì‹œì§€ëŠ” ë™ì ìœ¼ë¡œ ì±„ì›Œì§‘ë‹ˆë‹¤ -->
            </div>
            
            <!-- ëŒ€í™” ì˜µì…˜ ì˜ì—­ -->
            <div id="conversation-options" class="conversation-options"></div>

            <div class="input-area">
                <input type="text" id="message-input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." />
                <button class="send-btn" id="send-btn">ì „ì†¡</button>
            </div>
        </div>
        
        <!-- GPT ëŒ€í™” ì¶”ì²œ ì˜ì—­ - ì±„íŒ…ì°½ ì˜¤ë¥¸ìª½ -->
        <div class="gpt-recommendation-section">
            <div class="gpt-recommendation-header">
                <h3>ğŸ’¬ ëŒ€í™” ì¤‘ ì¶”ì²œ</h3>
            </div>
            <div id="gpt-recommendation-area" class="gpt-recommendation-area"></div>
        </div>
    </div>
    
    <!-- Python AI ê°œì¸í™” ì¶”ì²œ ì˜ì—­ - í•˜ë‹¨ ê³ ì • -->
    <div class="python-recommendation-section">
        <div class="python-recommendation-header">
            <h3>ğŸ¯ AI ë§ì¶¤ ì¶”ì²œ</h3>
        </div>
        <div id="python-recommendation-area" class="python-recommendation-area"></div>
    </div>
</div>

<script>
    const chatMessages = document.getElementById('chat-messages');
    const messageInput = document.getElementById('message-input');
    const sendBtn = document.getElementById('send-btn');
    const gptRecommendationArea = document.getElementById('gpt-recommendation-area');
    const pythonRecommendationArea = document.getElementById('python-recommendation-area');
    const conversationOptions = document.getElementById('conversation-options');

    const API_URL = '/chat';
    const sessionId = `session_${Date.now()}`;

    // í˜ì´ì§€ê°€ ë¡œë“œë˜ë©´, ì„œë²„ì— ì²« ì¸ì‚¬ë¥¼ ìš”ì²­í•©ë‹ˆë‹¤.
    // (ì´ í•¨ìˆ˜ëŠ” ì•„ë˜ì—ì„œ ì¬ì •ì˜ë©ë‹ˆë‹¤)

    // ë©”ì‹œì§€ë¥¼ ì„œë²„ë¡œ ë³´ë‚´ê³  ì‘ë‹µì„ ì²˜ë¦¬í•˜ëŠ” ë©”ì¸ í•¨ìˆ˜
    const sendMessage = async (messageText, isInitial = false) => {
        const message = isInitial ? messageText : messageInput.value.trim();
        if (message === '' && !isInitial) return;

        if (!isInitial) {
            addMessageToChat('user', message);
            messageInput.value = '';
        }

        gptRecommendationArea.innerHTML = '';
        conversationOptions.innerHTML = '';
        showTypingIndicator();

        try {
            const payload = { message: message, sessionId: sessionId };
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
            });

            if (!response.ok) throw new Error('ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜');

            const data = await response.json();
            hideTypingIndicator();

            addMessageToChat('bot', data.reply);

            // GPT ëŒ€í™” ì¶”ì²œì€ ì˜¤ë¥¸ìª½ ì˜ì—­ì— í‘œì‹œ
            if (data.recommendations && data.recommendations.length > 0) {
                console.log('GPT ì¶”ì²œ í‘œì‹œ:', data.recommendations);
                displayGPTRecommendationCards(data.recommendations);
                addGPTRecommendationClickEvents(data.recommendations);
            } else {
                console.log('GPT ì¶”ì²œì´ ì—†ìŒ, ê¸°ë³¸ ì¶”ì²œ í‘œì‹œ');
                // ê¸°ë³¸ ì¶”ì²œ í‘œì‹œ
                const defaultRecommendations = [
                    { foodName: 'ê¹€ì¹˜ì°Œê°œ', priceMin: 8000, priceMax: 10000 },
                    { foodName: 'ë¹„ë¹”ë°¥', priceMin: 9000, priceMax: 11000 },
                    { foodName: 'ì œìœ¡ë³¶ìŒ', priceMin: 10000, priceMax: 12000 }
                ];
                displayGPTRecommendationCards(defaultRecommendations);
                addGPTRecommendationClickEvents(defaultRecommendations);
            }

            // ëŒ€í™” ì˜µì…˜ í‘œì‹œ
            if (data.options && data.options.length > 0) {
                displayConversationOptionsFromResponse(data.options);
            }

        } catch (error) {
            console.error('Error:', error);
            hideTypingIndicator();
            addMessageToChat('bot', 'ì£„ì†¡í•´ìš”, ì§€ê¸ˆ ì„œë²„ì— ë¬¸ì œê°€ ìƒê²¨ì„œ ë‹µë³€ì„ ë“œë¦´ ìˆ˜ ì—†ì–´ìš”. ğŸ˜¥');
        }
    };

    // GPT ëŒ€í™” ì¶”ì²œ ì¹´ë“œ í‘œì‹œ í•¨ìˆ˜
    const displayGPTRecommendationCards = (recommendations) => {
        gptRecommendationArea.innerHTML = '';
        recommendations.forEach(rec => {
            const foodName = rec.foodName || rec.food_name;
            if (!foodName) return;

            const card = document.createElement('div');
            card.className = 'gpt-recommendation-card';
            card.setAttribute('data-food', foodName);
            card.style.cursor = 'pointer'; // í´ë¦­ ê°€ëŠ¥í•¨ì„ í‘œì‹œ

            const priceMin = rec.priceMin || rec.price_min || 0;
            const priceMax = rec.priceMax || rec.price_max || 0;

            card.innerHTML = `
                <h4>${foodName}</h4>
                <div class="price">${priceMin.toLocaleString()}ì› ~ ${priceMax.toLocaleString()}ì›</div>
                <div class="click-hint">í´ë¦­í•˜ì—¬ ê²€ìƒ‰</div>
            `;

            gptRecommendationArea.appendChild(card);
        });
    };
    
    // Python AI ê°œì¸í™” ì¶”ì²œ ì¹´ë“œ í‘œì‹œ í•¨ìˆ˜
    const displayPythonRecommendationCards = (recommendations) => {
        pythonRecommendationArea.innerHTML = '';
        
        if (!recommendations || recommendations.length === 0) {
            return;
        }
        
        recommendations.forEach((rec, index) => {
            const foodName = rec.foodName || rec.food_name;
            if (!foodName) {
                return;
            }

            const card = document.createElement('div');
            card.className = 'python-recommendation-card';
            card.setAttribute('data-food', foodName);

            let icon = 'ğŸ´';
            if(foodName.includes('êµ­ë°¥') || foodName.includes('ë¹„ë¹”ë°¥') || foodName.includes('ì œìœ¡')) icon = 'ğŸš';
            if(foodName.includes('ì§œì¥') || foodName.includes('ì§¬ë½•') || foodName.includes('íƒ•ìˆ˜ìœ¡')) icon = 'ğŸœ';
            if(foodName.includes('ì´ˆë°¥') || foodName.includes('ë¼ë©˜') || foodName.includes('ëˆê¹ŒìŠ¤')) icon = 'ğŸ£';
            if(foodName.includes('íŒŒìŠ¤íƒ€') || foodName.includes('í”¼ì') || foodName.includes('ìŠ¤í…Œì´í¬')) icon = 'ğŸ•';

            const priceMin = rec.priceMin || rec.price_min || 0;
            const priceDisplay = priceMin > 0 ? `ì•½ ${priceMin.toLocaleString()}ì› ~` : '';

            card.innerHTML = `
                <div class="food-icon">${icon}</div>
                <div class="food-name">${foodName}</div>
                <div class="food-price">${priceDisplay}</div>
            `;

            card.onclick = () => {
                addMessageToChat('user', `${foodName} ì¢‹ì•„ìš”!`);
                setTimeout(() => {
                    const encodedFoodName = encodeURIComponent(foodName);
                    window.location.href = `/foodMap?search=${encodedFoodName}`;
                }, 1000);
            };

            pythonRecommendationArea.appendChild(card);
        });
    };
    
    // ê¸°ì¡´ ì¶”ì²œ ì¹´ë“œ UIë¥¼ ë™ì ìœ¼ë¡œ ìƒì„±í•˜ëŠ” í•¨ìˆ˜ (í˜¸í™˜ì„± ìœ ì§€)
    const displayRecommendationCards = (recommendations) => {
        recommendations.forEach(rec => {
            // foodName ë˜ëŠ” food_name í•„ë“œ í™•ì¸
            const foodName = rec.foodName || rec.food_name;
            if (!foodName) return;

            const card = document.createElement('div');
            card.className = 'recommendation-card';

            let icon = 'ğŸ´';
            if(foodName.includes('êµ­ë°¥') || foodName.includes('ë¹„ë¹”ë°¥') || foodName.includes('ì œìœ¡')) icon = 'ğŸš';
            if(foodName.includes('ì§œì¥') || foodName.includes('ì§¬ë½•') || foodName.includes('íƒ•ìˆ˜ìœ¡')) icon = 'ğŸœ';
            if(foodName.includes('ì´ˆë°¥') || foodName.includes('ë¼ë©˜') || foodName.includes('ëˆê¹ŒìŠ¤')) icon = 'ğŸ£';
            if(foodName.includes('íŒŒìŠ¤íƒ€') || foodName.includes('í”¼ì') || foodName.includes('ìŠ¤í…Œì´í¬')) icon = 'ğŸ•';

            // ê°€ê²© ì •ë³´ ì²˜ë¦¬
            const priceMin = rec.priceMin || rec.price_min || 0;
            const priceDisplay = priceMin > 0 ? `ì•½ ${priceMin.toLocaleString()}ì› ~` : '';

            card.innerHTML = `
                <div class="food-icon">${icon}</div>
                <div class="food-name">${foodName}</div>
                <div class="food-price">${priceDisplay}</div>
            `;

            card.onclick = () => {
                // ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€
                addMessageToChat('user', `${foodName} ì¢‹ì•„ìš”!`);
                
                // ì ì‹œ í›„ foodMap.htmlë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ (ì‚¬ìš©ìê°€ ë©”ì‹œì§€ë¥¼ ë³¼ ìˆ˜ ìˆë„ë¡)
                setTimeout(() => {
                    const encodedFoodName = encodeURIComponent(foodName);
                    window.location.href = `/foodMap?search=${encodedFoodName}`;
                }, 1000);
            };

            pythonRecommendationArea.appendChild(card);
        });
    };

    // ì„œë²„ ì‘ë‹µì˜ ì˜µì…˜ì„ í‘œì‹œí•˜ëŠ” í•¨ìˆ˜
    const displayConversationOptionsFromResponse = (options) => {
        conversationOptions.innerHTML = '';
        options.forEach(option => {
            const optionElement = document.createElement('div');
            optionElement.className = 'conversation-option';
            optionElement.textContent = option.text;
            optionElement.onclick = () => {
                sendMessage(option.text);
            };
            conversationOptions.appendChild(optionElement);
        });
    };

    // ëŒ€í™” ì˜µì…˜ì„ í‘œì‹œí•˜ëŠ” í•¨ìˆ˜
    const displayConversationOptions = (recommendations) => {
        // ìŒì‹ ì„ íƒ ì˜µì…˜ë“¤
        recommendations.forEach(rec => {
            const foodName = rec.foodName || rec.food_name;
            if (foodName) {
                const option = document.createElement('div');
                option.className = 'conversation-option food-option';
                option.textContent = foodName;
                option.onclick = () => {
                    addMessageToChat('user', `${foodName} ì¢‹ì•„ìš”!`);
                    setTimeout(() => {
                        const encodedFoodName = encodeURIComponent(foodName);
                        window.location.href = `/foodMap?search=${encodedFoodName}`;
                    }, 1000);
                };
                conversationOptions.appendChild(option);
            }
        });

        // ëŒ€í™” ì´ì–´ê°€ê¸° ì˜µì…˜
        const continueOption = document.createElement('div');
        continueOption.className = 'conversation-option continue-option';
        continueOption.textContent = 'ë‹¤ë¥¸ ìŒì‹ë„ ì¶”ì²œí•´ì£¼ì„¸ìš”';
        continueOption.onclick = () => {
            sendMessage('ë‹¤ë¥¸ ìŒì‹ë„ ì¶”ì²œí•´ì£¼ì„¸ìš”');
        };
        conversationOptions.appendChild(continueOption);
    };

    // ëŒ€í™” ë©”ì‹œì§€ë¥¼ ì±„íŒ…ì°½ì— ì¶”ê°€í•˜ëŠ” í•¨ìˆ˜
    const addMessageToChat = (sender, text) => {
        if (text === '__INIT__') return;
        const messageElement = document.createElement('div');
        messageElement.className = sender === 'user' ? 'user-message' : 'bot-message';
        messageElement.innerHTML = text.replace(/\n/g, '<br>');
        chatMessages.appendChild(messageElement);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    };

    // 'ì…ë ¥ ì¤‘...' ì• ë‹ˆë©”ì´ì…˜ ê´€ë ¨ í•¨ìˆ˜ë“¤ (ê¸°ì¡´ê³¼ ë™ì¼)
    const showTypingIndicator = () => {
        const typingElement = document.createElement('div');
        typingElement.className = 'bot-message bot-typing';
        typingElement.id = 'typing-indicator';
        typingElement.innerHTML = '<div class="dot"></div><div class="dot"></div><div class="dot"></div>';
        chatMessages.appendChild(typingElement);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    };

    const hideTypingIndicator = () => {
        const typingIndicator = document.getElementById('typing-indicator');
        if(typingIndicator) {
            chatMessages.removeChild(typingIndicator);
        }
    };

    // ìì—°ìŠ¤ëŸ¬ìš´ ëŒ€í™” ì˜µì…˜ë“¤
    const addNaturalConversationOptions = () => {
        const naturalOptions = [
            'ë°°ê³ íŒŒìš” ğŸ˜‹',
            'ì˜¤ëŠ˜ ê¸°ë¶„ì´ ì¢‹ì•„ìš”! ğŸ˜Š',
            'ìŠ¤íŠ¸ë ˆìŠ¤ ë°›ì•˜ì–´ìš” ğŸ˜®â€ğŸ’¨',
            'ë‚ ì”¨ê°€ ì¶”ì›Œìš” â„ï¸',
            'ë””ì €íŠ¸ ë¨¹ê³  ì‹¶ì–´ìš” ğŸ°',
            'ì–´ë–¤ ìŒì‹ì´ ì¢‹ì„ê¹Œìš”? ğŸ¤”',
            'ì˜¤ëŠ˜ í˜ë“¤ì—ˆì–´ìš” ğŸ˜´',
            'ê¸°ë¶„ì´ ìš°ìš¸í•´ìš” ğŸ˜¢',
            'í”¼ê³¤í•´ìš” ğŸ˜©',
            'í–‰ë³µí•´ìš”! ğŸ‰',
            'ì‹œê°„ì´ ì—†ì–´ìš” â°',
            'ë­”ê°€ íŠ¹ë³„í•œ ê±° ë¨¹ê³  ì‹¶ì–´ìš” âœ¨'
        ];

        naturalOptions.forEach(text => {
            const button = document.createElement('div');
            button.className = 'conversation-option';
            button.textContent = text;
            button.onclick = () => {
                sendMessage(text);
            };
            conversationOptions.appendChild(button);
        });
    };

    // ì´ˆê¸° ëŒ€í™” ì˜µì…˜ í‘œì‹œ
    const showInitialOptions = () => {
        conversationOptions.innerHTML = '';
        addNaturalConversationOptions();
    };

    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    sendBtn.addEventListener('click', () => sendMessage());
    messageInput.addEventListener('keydown', (event) => {
        if (event.key === 'Enter') {
            sendMessage();
        }
    });

    // ì´ˆê¸° ì¶”ì²œ ë¡œë“œ
    const loadInitialRecommendations = async () => {
        try {
            const response = await fetch('/initial-recommendations');
            const data = await response.json();
            
            // AI ì‘ë‹µì„ ì±„íŒ…ì°½ì— í‘œì‹œ
            if (data.reply) {
                addMessageToChat('bot', data.reply);
            }
            
            // Python AI ê°œì¸í™” ì¶”ì²œì€ í•˜ë‹¨ ê³ ì • ì˜ì—­ì— í‘œì‹œ
            if (data.pythonRecommendations && data.pythonRecommendations.length > 0) {
                displayPythonRecommendationCards(data.pythonRecommendations);
            }
            
            // ëŒ€í™” ì˜µì…˜ í‘œì‹œ
            if (data.options && data.options.length > 0) {
                displayConversationOptionsFromResponse(data.options);
            }
            
        } catch (error) {
            console.error('ì´ˆê¸° ì¶”ì²œ ë¡œë“œ ì‹¤íŒ¨:', error);
        }
    };
    
    // GPT ì¶”ì²œ ìŒì‹ í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
    const addGPTRecommendationClickEvents = (recommendations) => {
        recommendations.forEach(rec => {
            const foodName = rec.foodName || rec.food_name;
            const card = document.querySelector(`[data-food="${foodName}"]`);
            if (card) {
                card.addEventListener('click', () => {
                    console.log('GPT ì¶”ì²œ í´ë¦­ë¨:', foodName);
                    const searchUrl = `/foodMap?search=${encodeURIComponent(foodName)}`;
                    console.log('ì´ë™í•  URL:', searchUrl);
                    // ìŒì‹ ì„ íƒ ì‹œ foodMapìœ¼ë¡œ ì´ë™
                    window.location.href = searchUrl;
                });
            }
        });
    };
    
    
    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸° ì¶”ì²œ ë¡œë“œ
    window.onload = async () => {
        await loadInitialRecommendations();
    };

</script>
</body>
</html>

