<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/css/foodMap.css">
    <title>맛집 지도 - LunchBot</title>
    <!-- REST API 사용 - JavaScript API 제거 -->
</head>
<body>

    <header>
        <div class="header-container">
            <p>LunchBot 오늘 뭐 먹을까?</p>
            <div class="input-group">
                <label for="search-food">음식 검색</label>
                <input type="text" id="search-food" name="search-food" placeholder="음식/장소를 입력하세요">
                <button id="search-btn" class="search-btn">검색</button>
            </div>
        </div>
    </header>

    <div class="main-wrapper">
        <div class="main-content">
            <div class="upper-content">
                <div class="upper-map" id="map">
                    <!-- 네이버 지도가 여기에 표시됩니다 -->
                </div>
            </div>
            <div class="lower-content">
                <div class="short-info" id="search-result">
                    <h4>검색 결과</h4>
                    <p>음식이나 장소를 검색해보세요!</p>
                </div>
                <div class="short-info" id="place-info">
                    <h4>장소 정보</h4>
                    <p>지도에서 장소를 선택하세요.</p>
                </div>
            </div>
        </div>
        <div class="right-side-content">

        </div>
    </div>
    
</body>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
    // REST API 방식으로 지도 표시
    document.addEventListener('DOMContentLoaded', function() {
        // 지도 컨테이너 초기화
        initMapDisplay();
        
        // 검색 버튼 클릭 이벤트
        document.getElementById('search-btn').addEventListener('click', searchFood);
        
        // 엔터키로 검색
        document.getElementById('search-food').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchFood();
            }
        });
    });

    // 지도 표시 초기화 (REST API 방식)
    function initMapDisplay() {
        const mapContainer = document.getElementById('map');
        mapContainer.innerHTML = `
            <div style="width: 100%; height: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 15px; display: flex; align-items: center; justify-content: center; color: white; text-align: center; position: relative;">
                <div>
                    <h3 style="margin-bottom: 20px; font-size: 24px;">🗺️ 맛집 지도</h3>
                    <p style="margin-bottom: 15px;">음식이나 장소를 검색해보세요!</p>
                    <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                        <div style="background: rgba(255,255,255,0.2); padding: 8px 12px; border-radius: 20px; font-size: 14px;">
                            📍 검색
                        </div>
                        <div style="background: rgba(255,255,255,0.2); padding: 8px 12px; border-radius: 20px; font-size: 14px;">
                            🍽️ 맛집
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    // 음식/장소 검색 함수 (REST API)
    function searchFood() {
        const query = document.getElementById('search-food').value.trim();
        
        if (!query) {
            alert('검색어를 입력해주세요!');
            return;
        }
        
        console.log('검색 시작:', query);
        
        // 검색 중 표시
        document.getElementById('search-result').innerHTML = `
            <h4>🔍 검색 중...</h4>
            <p>${query}를 검색하고 있습니다...</p>
        `;
        
        // 서버에 검색 요청 (REST API) - axios 사용
        axios.get(`/api/map/search`, {
            params: {
                query: query
            },
            timeout: 10000 // 10초 타임아웃
        })
        .then(response => {
            console.log('axios 응답:', response);
            console.log('응답 데이터:', response.data);
            
            const data = response.data;
            
            if (data.error) {
                // 에러 응답 처리
                document.getElementById('search-result').innerHTML = `
                    <h4>❌ 검색 오류</h4>
                    <p>${data.message || data.error}</p>
                `;
                return;
            }
            
            if (data.addresses && data.addresses.length > 0) {
                // 첫 번째 결과 사용
                const firstResult = data.addresses[0];
                console.log('검색 결과:', firstResult);
                
                // 지도 업데이트 (REST API 결과 표시)
                updateMapWithResult(firstResult);
                
                // 검색 결과 표시
                displaySearchResult(firstResult);
            } else {
                alert('검색 결과가 없습니다.');
                document.getElementById('search-result').innerHTML = `
                    <h4>❌ 검색 결과 없음</h4>
                    <p>검색 결과가 없습니다. 다른 검색어를 입력해보세요.</p>
                `;
            }
        })
        .catch(error => {
            console.error('axios 오류:', error);
            
            if (error.response) {
                // 서버에서 응답을 받았지만 오류 상태
                console.error('응답 오류:', error.response.status, error.response.data);
                document.getElementById('search-result').innerHTML = `
                    <h4>❌ 서버 오류</h4>
                    <p>서버 오류 (${error.response.status}): ${error.response.data}</p>
                `;
            } else if (error.request) {
                // 요청이 전송되었지만 응답을 받지 못함
                console.error('네트워크 오류:', error.request);
                document.getElementById('search-result').innerHTML = `
                    <h4>❌ 네트워크 오류</h4>
                    <p>서버에 연결할 수 없습니다.</p>
                `;
            } else {
                // 요청 설정 중 오류
                console.error('요청 오류:', error.message);
                document.getElementById('search-result').innerHTML = `
                    <h4>❌ 요청 오류</h4>
                    <p>${error.message}</p>
                `;
            }
        });
    }

    // REST API 결과로 지도 업데이트
    function updateMapWithResult(result) {
        const mapContainer = document.getElementById('map');
        const lat = parseFloat(result.y);
        const lng = parseFloat(result.x);
        
        mapContainer.innerHTML = `
            <div style="width: 100%; height: 100%; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); border-radius: 15px; display: flex; align-items: center; justify-content: center; color: white; text-align: center; position: relative;">
                <div>
                    <h3 style="margin-bottom: 20px; font-size: 24px;">📍 ${result.roadAddress || result.jibunAddress}</h3>
                    <p style="margin-bottom: 15px;">위도: ${lat.toFixed(6)}, 경도: ${lng.toFixed(6)}</p>
                    <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                        <div style="background: rgba(255,255,255,0.3); padding: 8px 12px; border-radius: 20px; font-size: 14px;">
                            📍 위치 확인됨
                        </div>
                        <div style="background: rgba(255,255,255,0.3); padding: 8px 12px; border-radius: 20px; font-size: 14px;">
                            🗺️ 지도 표시
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    // 검색 결과 표시
    function displaySearchResult(result) {
        const resultDiv = document.getElementById('search-result');
        resultDiv.innerHTML = `
            <h4>📍 검색 결과</h4>
            <p><strong>${result.roadAddress || result.jibunAddress}</strong></p>
            <p style="font-size: 14px; color: #666;">위도: ${result.y}, 경도: ${result.x}</p>
        `;
        
        const placeDiv = document.getElementById('place-info');
        placeDiv.innerHTML = `
            <h4>🍽️ 장소 정보</h4>
            <p>${result.roadAddress || result.jibunAddress}</p>
        `;
    }
</script>
</html>
