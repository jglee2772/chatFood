<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë§›ì§‘ ì§€ë„ - LunchBot</title>
    <link rel="stylesheet" href="/css/foodMap.css">
</head>
<body>
    <header>
        <div class="header-container">
            <p>LunchBot - ë§›ì§‘ ê²€ìƒ‰</p>
            <div class="input-group">
                <label for="search-input">ë§›ì§‘ ê²€ìƒ‰</label>
                <input type="text" id="search-input" placeholder="ì˜ˆ: ì´ˆë°¥, í”¼ì, ì¹˜í‚¨">
                <button id="search-btn" class="search-btn">ê²€ìƒ‰</button>
            </div>
        </div>
    </header>

    <div class="main-wrapper">
        <div class="main-content">
            <div class="upper-content">
                <div id="map" class="upper-map"></div>
            </div>
            <div class="lower-content">
                <div class="short-info" id="result-list">
                    <h4>ğŸ½ï¸ ê²€ìƒ‰ ê²°ê³¼</h4>
                    <p>ìŒì‹ ì´ë¦„ì´ë‚˜ ê°€ê²Œë¥¼ ê²€ìƒ‰í•´ë³´ì„¸ìš”!</p>
                </div>
                <div class="short-info" id="detail-info">
                    <h4>ğŸ½ï¸ ë§›ì§‘ ì •ë³´</h4>
                    <p>ê²€ìƒ‰ ê²°ê³¼ë¥¼ í´ë¦­í•˜ë©´ ìƒì„¸ ì •ë³´ê°€ í‘œì‹œë©ë‹ˆë‹¤.</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script th:inline="javascript">
        // ============================================
        // ì „ì—­ ë³€ìˆ˜
        // ============================================
        let map;
        let markers = [];
        let restaurants = [];
        const KAKAO_JS_KEY = /*[[${kakaoJsKey}]]*/ '';

        // ============================================
        // ì´ˆê¸°í™”
        // ============================================
        window.addEventListener('DOMContentLoaded', async function() {
            try {
                await loadKakaoMapScript();
                initMap();
                initEventListeners();
            } catch (error) {
                showErrorMessage(error.message);
            }
        });

        // ============================================
        // ì¹´ì¹´ì˜¤ ì§€ë„ ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ
        // ============================================
        function loadKakaoMapScript() {
            return new Promise((resolve, reject) => {
                if (!KAKAO_JS_KEY || KAKAO_JS_KEY.includes('ë°œê¸‰ë°›ì€')) {
                    reject(new Error('ì¹´ì¹´ì˜¤ JavaScript í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.'));
                    return;
                }

                const script = document.createElement('script');
                script.src = `https://dapi.kakao.com/v2/maps/sdk.js?appkey=${KAKAO_JS_KEY}&autoload=false`;
                script.onload = () => {
                    kakao.maps.load(() => {
                        console.log('âœ… ì¹´ì¹´ì˜¤ ì§€ë„ SDK ë¡œë“œ ì™„ë£Œ');
                        resolve();
                    });
                };
                script.onerror = () => reject(new Error('ì¹´ì¹´ì˜¤ ì§€ë„ ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì‹¤íŒ¨'));
                document.head.appendChild(script);
            });
        }

        // ============================================
        // ì§€ë„ ì´ˆê¸°í™”
        // ============================================
        function initMap() {
            const container = document.getElementById('map');
            const options = {
                center: new kakao.maps.LatLng(37.5665, 126.9780),
                level: 5
            };
            map = new kakao.maps.Map(container, options);
            console.log('âœ… ì§€ë„ ì´ˆê¸°í™” ì™„ë£Œ');
        }

        // ============================================
        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
        // ============================================
        function initEventListeners() {
            document.getElementById('search-btn').addEventListener('click', searchRestaurants);
            document.getElementById('search-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') searchRestaurants();
            });
        }

        // ============================================
        // ë§›ì§‘ ê²€ìƒ‰
        // ============================================
        function searchRestaurants() {
            const query = document.getElementById('search-input').value.trim();
            if (!query) {
                alert('ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!');
                return;
            }

            showLoadingMessage(query);
            clearMarkers();

            // í˜„ì¬ ì§€ë„ ì¤‘ì‹¬ ì¢Œí‘œ ê°€ì ¸ì˜¤ê¸°
            const center = map.getCenter();
            
            const params = {
                query: query,
                x: center.getLng(),  // ê²½ë„
                y: center.getLat(),  // ìœ„ë„
                radius: 20000        // ê²€ìƒ‰ ë°˜ê²½ 20km
            };

            console.log('ğŸ” ê²€ìƒ‰ íŒŒë¼ë¯¸í„°:', params);

            axios.get('/api/restaurants/search', { params: params, timeout: 10000 })
                .then(response => handleSearchSuccess(response.data, query))
                .catch(error => handleSearchError(error));
        }

        // ============================================
        // ê²€ìƒ‰ ì„±ê³µ ì²˜ë¦¬
        // ============================================
        function handleSearchSuccess(data, query) {
            // ì‘ë‹µ ë°ì´í„° ì „ì²´ ì¶œë ¥ (ë””ë²„ê¹…ìš©)
            console.log('ğŸ“¦ API ì‘ë‹µ ë°ì´í„°:', data);
            console.log('ğŸ“¦ documents:', data.documents);
            console.log('ğŸ“¦ meta:', data.meta);
            
            if (data.error === 'API_KEY_NOT_CONFIGURED') {
                showApiKeyGuide();
                return;
            }

            if (data.error) {
                console.error('âŒ ì—ëŸ¬ ë°œìƒ:', data.error, data.message);
                showErrorResult(data.message || data.error);
                return;
            }

            if (data.documents && data.documents.length > 0) {
                restaurants = data.documents;
                displayResults(data.documents);
                showMarkers(data.documents);
                moveMapToFirstResult(data.documents[0]);
                console.log(`âœ… ê²€ìƒ‰ ì™„ë£Œ: ${data.documents.length}ê°œ ê²°ê³¼`);
            } else {
                console.warn('âš ï¸ ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ. documents:', data.documents);
                showNoResult(query);
            }
        }

        // ============================================
        // ê²€ìƒ‰ ì˜¤ë¥˜ ì²˜ë¦¬
        // ============================================
        function handleSearchError(error) {
            console.error('âŒ ê²€ìƒ‰ ì˜¤ë¥˜:', error);
            document.getElementById('result-list').innerHTML = `
                <h4>âŒ ê²€ìƒ‰ ì˜¤ë¥˜</h4>
                <p>ê²€ìƒ‰ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>
            `;
        }

        // ============================================
        // ê²€ìƒ‰ ê²°ê³¼ í‘œì‹œ
        // ============================================
        function displayResults(items) {
            let html = `<h4>ğŸ½ï¸ ê²€ìƒ‰ ê²°ê³¼ (${items.length}ê°œ)</h4>`;
            html += '<div style="max-height: 350px; overflow-y: auto;">';

            items.forEach((item, index) => {
                html += createResultItem(item, index);
            });

            html += '</div>';
            document.getElementById('result-list').innerHTML = html;
            showDetail(items[0]);
        }

        // ============================================
        // ê²€ìƒ‰ ê²°ê³¼ ì•„ì´í…œ ìƒì„±
        // ============================================
        function createResultItem(item, index) {
            const placeName = item.place_name;
            const address = item.road_address_name || item.address_name;
            const category = item.category_name;
            const distance = item.distance ? `ğŸ“ ${item.distance}m` : '';

            return `
                <div onclick="selectRestaurant(${index})" style="
                    padding: 12px;
                    margin: 8px 0;
                    background: white;
                    border-radius: 8px;
                    border: 2px solid ${index === 0 ? '#FF914D' : '#e0e0e0'};
                    cursor: pointer;
                    transition: all 0.2s;
                " onmouseover="this.style.borderColor='#FF914D'" 
                   onmouseout="this.style.borderColor='${index === 0 ? '#FF914D' : '#e0e0e0'}'">
                    <p style="font-weight: bold; color: #333; margin-bottom: 5px; font-size: 15px;">
                        ${index + 1}. ${placeName}
                    </p>
                    <p style="font-size: 13px; color: #666; margin-bottom: 3px;">ğŸ“ ${address}</p>
                    <p style="font-size: 12px; color: #999;">ğŸ·ï¸ ${category} ${distance}</p>
                </div>
            `;
        }

        // ============================================
        // ë§ˆì»¤ í‘œì‹œ
        // ============================================
        function showMarkers(items) {
            items.forEach((item, index) => {
                const position = new kakao.maps.LatLng(item.y, item.x);
                const marker = createMarker(position, item, index);
                markers.push(marker);
            });
            console.log(`âœ… ${markers.length}ê°œ ë§ˆì»¤ ìƒì„± ì™„ë£Œ`);
        }

        // ============================================
        // ë§ˆì»¤ ìƒì„±
        // ============================================
        function createMarker(position, item, index) {
            const marker = new kakao.maps.Marker({
                position: position,
                map: map
            });

            const infowindow = new kakao.maps.InfoWindow({
                content: createInfoWindowContent(item, index)
            });

            kakao.maps.event.addListener(marker, 'click', function() {
                closeAllInfoWindows();
                infowindow.open(map, marker);
                selectRestaurant(index);
            });

            return { marker, infowindow };
        }

        // ============================================
        // ì¸í¬ìœˆë„ìš° ì½˜í…ì¸  ìƒì„±
        // ============================================
        function createInfoWindowContent(item, index) {
            return `
                <div style="padding:10px; min-width:200px;">
                    <div style="font-weight:bold; color:#FF914D; margin-bottom:5px;">
                        ${index + 1}. ${item.place_name}
                    </div>
                    <div style="font-size:12px; color:#666;">
                        ${item.road_address_name || item.address_name}
                    </div>
                </div>
            `;
        }

        // ============================================
        // ë§›ì§‘ ì„ íƒ
        // ============================================
        function selectRestaurant(index) {
            const item = restaurants[index];
            const position = new kakao.maps.LatLng(item.y, item.x);
            
            map.panTo(position);
            map.setLevel(3);
            showDetail(item);
            
            closeAllInfoWindows();
            markers[index].infowindow.open(map, markers[index].marker);
        }

        // ============================================
        // ìƒì„¸ ì •ë³´ í‘œì‹œ
        // ============================================
        function showDetail(item) {
            const html = `
                <h4>ğŸ½ï¸ ${item.place_name}</h4>
                <p style="margin: 10px 0;"><strong>ì£¼ì†Œ</strong><br>${item.road_address_name || item.address_name}</p>
                <p style="margin: 10px 0;"><strong>ì „í™”</strong><br>${item.phone || 'ì •ë³´ ì—†ìŒ'}</p>
                <p style="margin: 10px 0;"><strong>ì¹´í…Œê³ ë¦¬</strong><br>${item.category_name}</p>
                <p style="margin: 10px 0;"><strong>ì¢Œí‘œ</strong><br>ìœ„ë„: ${item.y}<br>ê²½ë„: ${item.x}</p>
                ${item.place_url ? `<p><a href="${item.place_url}" target="_blank" style="color: #FF914D; text-decoration: underline; font-weight: bold;">ì¹´ì¹´ì˜¤ë§µì—ì„œ ë³´ê¸° â†’</a></p>` : ''}
            `;
            document.getElementById('detail-info').innerHTML = html;
        }

        // ============================================
        // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
        // ============================================
        function clearMarkers() {
            markers.forEach(m => {
                m.marker.setMap(null);
                m.infowindow.close();
            });
            markers = [];
        }

        function closeAllInfoWindows() {
            markers.forEach(m => m.infowindow.close());
        }

        function moveMapToFirstResult(item) {
            const position = new kakao.maps.LatLng(item.y, item.x);
            map.setCenter(position);
            map.setLevel(5);
        }

        function showLoadingMessage(query) {
            document.getElementById('result-list').innerHTML = `
                <h4>ğŸ” ê²€ìƒ‰ ì¤‘...</h4>
                <p>"${query}" ë§›ì§‘ì„ ì°¾ê³  ìˆìŠµë‹ˆë‹¤...</p>
            `;
        }

        function showNoResult(query) {
            document.getElementById('result-list').innerHTML = `
                <h4>ğŸ˜¢ ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ</h4>
                <p>"${query}" ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                <p style="font-size: 13px; color: #999; margin-top: 10px;">ë‹¤ë¥¸ ê²€ìƒ‰ì–´ë¥¼ ì‹œë„í•´ë³´ì„¸ìš”!</p>
            `;
        }

        function showErrorResult(message) {
            document.getElementById('result-list').innerHTML = `
                <h4>âŒ ê²€ìƒ‰ ì˜¤ë¥˜</h4>
                <p>${message}</p>
            `;
        }

        function showErrorMessage(message) {
            console.error('âŒ ì´ˆê¸°í™” ì˜¤ë¥˜:', message);
            document.getElementById('map').innerHTML = `
                <div style="display: flex; justify-content: center; align-items: center; height: 100%; background: #f5f5f5; flex-direction: column; padding: 20px;">
                    <h3 style="color: #ff6b6b; margin-bottom: 15px;">âš ï¸ ì§€ë„ ë¡œë“œ ì‹¤íŒ¨</h3>
                    <p style="color: #666; margin-bottom: 10px;">${message}</p>
                    <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border-left: 4px solid #ffc107; max-width: 500px;">
                        <p style="font-size: 14px; margin: 5px 0;"><strong>í™•ì¸ ì‚¬í•­:</strong></p>
                        <p style="font-size: 13px; margin: 5px 0;">1. application.propertiesì— ì¹´ì¹´ì˜¤ JavaScript í‚¤ ì„¤ì •</p>
                        <p style="font-size: 13px; margin: 5px 0;">2. ì¹´ì¹´ì˜¤ ê°œë°œì ì„¼í„°ì—ì„œ í”Œë«í¼ ë„ë©”ì¸ ì„¤ì •</p>
                        <p style="font-size: 13px; margin: 5px 0;">3. ë¸Œë¼ìš°ì € ì½˜ì†”ì—ì„œ ìƒì„¸ ì—ëŸ¬ í™•ì¸</p>
                    </div>
                </div>
            `;
        }

        function showApiKeyGuide() {
            document.getElementById('result-list').innerHTML = `
                <h4>âš™ï¸ ì¹´ì¹´ì˜¤ API í‚¤ ì„¤ì • í•„ìš”</h4>
                <p style="margin-bottom: 15px;">ë§›ì§‘ ê²€ìƒ‰ì„ ì‚¬ìš©í•˜ë ¤ë©´ ì¹´ì¹´ì˜¤ API í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤.</p>
                <div style="background: #fff3cd; padding: 12px; border-radius: 8px; border-left: 4px solid #ffc107; text-align: left;">
                    <p style="font-size: 14px; margin: 8px 0; font-weight: bold;">ğŸ“‹ ì„¤ì • ë°©ë²•:</p>
                    <p style="font-size: 13px; margin: 5px 0;">1. <a href="https://developers.kakao.com/" target="_blank" style="color: #0066cc;">developers.kakao.com</a> ì ‘ì†</p>
                    <p style="font-size: 13px; margin: 5px 0;">2. ë‚´ ì• í”Œë¦¬ì¼€ì´ì…˜ â†’ ì• í”Œë¦¬ì¼€ì´ì…˜ ì¶”ê°€</p>
                    <p style="font-size: 13px; margin: 5px 0;">3. í”Œë«í¼ ì„¤ì • â†’ Web í”Œë«í¼ ë“±ë¡</p>
                    <p style="font-size: 13px; margin: 5px 0;">4. REST API í‚¤ì™€ JavaScript í‚¤ ë³µì‚¬</p>
                    <p style="font-size: 13px; margin: 5px 0;">5. application.propertiesì— ì¶”ê°€</p>
                </div>
            `;
        }
    </script>
</body>
</html>
