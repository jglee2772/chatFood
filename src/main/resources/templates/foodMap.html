<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë§›ì§‘ ì§€ë„ - LunchBot</title>
    <link rel="stylesheet" href="/css/foodMap.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700;800&display=swap" rel="stylesheet">
</head>

<body>
    <!-- ğŸ  í—¤ë” ì˜ì—­ -->
    <header>
        <h1>ğŸ± LunchBot ë§›ì§‘ ì§€ë„</h1>
        <p>AIê°€ ë‚´ ì£¼ë³€ ë§›ì§‘ì„ ì°¾ì•„ë“œë¦´ê²Œìš”</p>
        
        <!-- ğŸ” ê²€ìƒ‰ì°½ -->
        <div class="search-box">
            <input type="text" id="search-input" placeholder="ì˜ˆ: ì´ˆë°¥, ëˆê¹ŒìŠ¤, íŒŒìŠ¤íƒ€">
            <button id="search-btn">ê²€ìƒ‰</button>
        </div>
    </header>

    <!-- ğŸ“± ë©”ì¸ ì½˜í…ì¸  -->
    <div class="main-wrapper">
        <!-- ğŸ—ºï¸ ì§€ë„ ì˜ì—­ -->
        <div class="upper-content">
            <div id="map"></div>
            <div class="map-title">ğŸ“ ë‚´ ì£¼ë³€ ë§›ì§‘ íƒìƒ‰ ì¤‘...</div>
        </div>

        <!-- ğŸ“‹ ë§›ì§‘ ì„¸ë¶€ì •ë³´ ì˜ì—­ -->
        <div class="detail-section">
            <h3>ğŸ½ï¸ ë§›ì§‘ ìƒì„¸ì •ë³´</h3>
            <div id="restaurant-detail-info">
                <div id="restaurant-detail-content">
                    <p class="no-selection">ì§€ë„ì—ì„œ ìŒì‹ì ì„ í´ë¦­í•˜ë©´ ìƒì„¸ì •ë³´ê°€ í‘œì‹œë©ë‹ˆë‹¤</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ğŸ† ì¶”ì²œ ë§›ì§‘ TOP 3 (í•˜ë‹¨ ê°€ë¡œ ë°°ì¹˜) -->
    <div class="recommended-section">
        <h3>ğŸ† AI ì¶”ì²œ ë§›ì§‘ TOP 3</h3>
        <div id="restaurant-list" class="restaurant-list-horizontal"></div>
    </div>

    <!-- ğŸ“š ì¹´ì¹´ì˜¤ ì§€ë„ API -->
    <!-- í™˜ê²½ ë³€ìˆ˜ì—ì„œ API í‚¤ë¥¼ ë™ì ìœ¼ë¡œ ë¡œë“œ -->
    <script th:inline="javascript">
        /*<![CDATA[*/
        // ì¹´ì¹´ì˜¤ API ì´ˆê¸°í™” í•¨ìˆ˜
        function initializeKakaoAPI() {
            // ì„œë²„ì—ì„œ ì „ë‹¬ë°›ì€ ì¹´ì¹´ì˜¤ API í‚¤ ì‚¬ìš©
            const kakaoApiKey = /*[[${kakaoApiKey}]]*/ '';
            
            console.log('ğŸ”‘ ì¹´ì¹´ì˜¤ API í‚¤ í™•ì¸:', kakaoApiKey);
            
            // API í‚¤ê°€ ë¹„ì–´ìˆìœ¼ë©´ ì—ëŸ¬ ì²˜ë¦¬
            if (!kakaoApiKey || kakaoApiKey.trim() === '') {
                console.error('âŒ ì¹´ì¹´ì˜¤ API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                alert('ì¹´ì¹´ì˜¤ ì§€ë„ API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            const finalApiKey = kakaoApiKey;
            console.log('ğŸ”‘ ìµœì¢… ì‚¬ìš©í•  API í‚¤:', finalApiKey);
            
            // ì¹´ì¹´ì˜¤ ì§€ë„ API ë™ì  ë¡œë“œ
            const script = document.createElement('script');
            script.src = `//dapi.kakao.com/v2/maps/sdk.js?appkey=${finalApiKey}&libraries=services`;
            script.async = true;
            
            // ì¹´ì¹´ì˜¤ API ë¡œë“œ ì™„ë£Œ í›„ ì½œë°± í•¨ìˆ˜ ì„¤ì •
            script.onload = function() {
                console.log('âœ… ì¹´ì¹´ì˜¤ API ë¡œë“œ ì™„ë£Œ');
                // API ë¡œë“œ ì™„ë£Œ í›„ ì´ˆê¸°í™” í•¨ìˆ˜ í˜¸ì¶œ
                initializeMapAfterKakaoLoad();
            };
            
            script.onerror = function() {
                console.error('âŒ ì¹´ì¹´ì˜¤ API ë¡œë“œ ì‹¤íŒ¨');
                console.error('ì‚¬ìš©ëœ API í‚¤:', finalApiKey);
                console.error('í˜„ì¬ ë„ë©”ì¸:', window.location.hostname);
                console.error('í˜„ì¬ í”„ë¡œí† ì½œ:', window.location.protocol);
                
                // ëŒ€ì²´ ë¡œë”© ë°©ì‹ ì‹œë„ (HTTPS/HTTP)
                console.log('ğŸ”„ ëŒ€ì²´ ë¡œë”© ë°©ì‹ ì‹œë„ ì¤‘...');
                const alternativeScript = document.createElement('script');
                const alternativeUrl = window.location.protocol === 'https:' 
                    ? `https://dapi.kakao.com/v2/maps/sdk.js?appkey=${finalApiKey}&libraries=services`
                    : `http://dapi.kakao.com/v2/maps/sdk.js?appkey=${finalApiKey}&libraries=services`;
                
                alternativeScript.src = alternativeUrl;
                alternativeScript.async = true;
                
                alternativeScript.onload = function() {
                    console.log('âœ… ëŒ€ì²´ ë°©ì‹ìœ¼ë¡œ ì¹´ì¹´ì˜¤ API ë¡œë“œ ì„±ê³µ');
                    initializeMapAfterKakaoLoad();
                };
                
                alternativeScript.onerror = function() {
                    console.error('âŒ ëŒ€ì²´ ë°©ì‹ë„ ì‹¤íŒ¨');
                    
                    // ì§€ë„ ì˜ì—­ì— ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
                    const mapContainer = document.getElementById('map');
                    if (mapContainer) {
                        mapContainer.innerHTML = `
                            <div style="display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100%; background: #f5f5f5; border-radius: 8px; padding: 20px; text-align: center;">
                                <div style="font-size: 48px; margin-bottom: 16px;">ğŸ—ºï¸</div>
                                <h3 style="color: #666; margin-bottom: 8px;">ì§€ë„ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</h3>
                                <p style="color: #999; font-size: 14px;">ì¹´ì¹´ì˜¤ ì§€ë„ API ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.</p>
                                <p style="color: #999; font-size: 12px; margin-top: 8px;">
                                    ë„ë©”ì¸: ${window.location.hostname}<br>
                                    í”„ë¡œí† ì½œ: ${window.location.protocol}
                                </p>
                                <button onclick="location.reload()" style="margin-top: 16px; padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">ìƒˆë¡œê³ ì¹¨</button>
                            </div>
                        `;
                    }
                    
                    // ê²€ìƒ‰ ê¸°ëŠ¥ ë¹„í™œì„±í™”
                    const searchInput = document.getElementById('search-input');
                    const searchBtn = document.getElementById('search-btn');
                    if (searchInput) searchInput.disabled = true;
                    if (searchBtn) searchBtn.disabled = true;
                };
                
                document.head.appendChild(alternativeScript);
            };
            
            document.head.appendChild(script);
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì¹´ì¹´ì˜¤ API ì´ˆê¸°í™” ì‹¤í–‰
        initializeKakaoAPI();
        /*]]>*/
    </script>
    <!-- ğŸ  í™ˆ ë²„íŠ¼ -->
    <div class="home-btn" onclick="window.location.href='/'">ğŸ </div>

    <!-- ğŸš€ JavaScript ì½”ë“œ -->
    <script>
        // ============================================
        // ì „ì—­ ë³€ìˆ˜
        // ============================================
        let map;
        let userLocation = null;
        let markers = [];
        let infowindow;

        // ============================================
        // ì‚¬ìš©ì í˜„ì¬ ìœ„ì¹˜ ê°€ì ¸ì˜¤ê¸°
        // ============================================
        async function getUserLocation() {
            return new Promise((resolve) => {
                if (!navigator.geolocation) {
                    console.warn('âš ï¸ Geolocationì„ ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤.');
                    userLocation = { lat: 37.5665, lng: 126.9780 }; // ì„œìš¸ ì‹œì²­
                    resolve();
                    return;
                }

                console.log('ğŸ“ í˜„ì¬ ìœ„ì¹˜ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘...');

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        console.log('âœ… í˜„ì¬ ìœ„ì¹˜:', userLocation);
                        resolve();
                    },
                    (error) => {
                        console.warn('âš ï¸ ìœ„ì¹˜ ê¶Œí•œ ê±°ë¶€ ë˜ëŠ” ì˜¤ë¥˜:', error.message);
                        userLocation = { lat: 37.5665, lng: 126.9780 }; // ì„œìš¸ ì‹œì²­
                        resolve();
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            });
        }

        // ============================================
        // ì§€ë„ ì´ˆê¸°í™”
        // ============================================
        function initMap() {
            console.log('ğŸ—ºï¸ ì§€ë„ ì´ˆê¸°í™” ì‹œì‘');
            
            try {
                const center = new kakao.maps.LatLng(userLocation.lat, userLocation.lng);
                const container = document.getElementById("map");
                const options = { 
                    center, 
                    level: 5 
                };
                
                map = new kakao.maps.Map(container, options);
                
                // ë‚´ ìœ„ì¹˜ ë§ˆì»¤ ì¶”ê°€
                const marker = new kakao.maps.Marker({ 
                    position: center, 
                    map 
                });
                
                const info = new kakao.maps.InfoWindow({
                    content: '<div style="padding:5px;font-size:12px;">ğŸ“ ë‚´ ìœ„ì¹˜</div>'
                });
                info.open(map, marker);
                
                console.log('âœ… ì§€ë„ ì´ˆê¸°í™” ì™„ë£Œ');
                
                // ê¸°ë³¸ ë§›ì§‘ ê²€ìƒ‰
                searchPlaces("ë§›ì§‘");
                
            } catch (error) {
                console.error('âŒ ì§€ë„ ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
                alert('ì§€ë„ ì´ˆê¸°í™” ì‹¤íŒ¨: ' + error.message);
            }
        }

        // ============================================
        // ì¥ì†Œ ê²€ìƒ‰
        // ============================================
        function searchPlaces(keyword) {
            console.log('ğŸ” ê²€ìƒ‰ ì‹œì‘:', keyword);
            
            if (!userLocation) {
                alert('ğŸ“ ìœ„ì¹˜ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ìœ„ì¹˜ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            // ê¸°ì¡´ ë§ˆì»¤ë“¤ ì œê±°
            clearMarkers();
            
            // ì¥ì†Œ ê²€ìƒ‰ ì„œë¹„ìŠ¤ ê°ì²´ ìƒì„±
            const ps = new kakao.maps.services.Places();
            
            // ê²€ìƒ‰ ì˜µì…˜ ì„¤ì • (ë‚´ ìœ„ì¹˜ ê¸°ì¤€ 2km ë°˜ê²½)
            const options = {
                location: new kakao.maps.LatLng(userLocation.lat, userLocation.lng),
                radius: 2000, // 2km ë°˜ê²½
                sort: kakao.maps.services.SortBy.DISTANCE // ê±°ë¦¬ìˆœ ì •ë ¬
            };
            
            // í‚¤ì›Œë“œë¡œ ì¥ì†Œ ê²€ìƒ‰
            ps.keywordSearch(keyword, placesSearchCB, options);
        }

        // ============================================
        // ê²€ìƒ‰ ê²°ê³¼ ì²˜ë¦¬
        // ============================================
        function placesSearchCB(data, status) {
            if (status !== kakao.maps.services.Status.OK) {
                console.warn('âš ï¸ ê²€ìƒ‰ ì‹¤íŒ¨:', status);
                alert('ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. ë‹¤ë¥¸ í‚¤ì›Œë“œë¡œ ì‹œë„í•´ë³´ì„¸ìš”.');
                return;
            }

            console.log('âœ… ê²€ìƒ‰ ê²°ê³¼:', data.length + 'ê°œ');
            
            // ê²€ìƒ‰ëœ ì¥ì†Œ ìœ„ì¹˜ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì§€ë„ ë²”ìœ„ ì¬ì„¤ì •
            const bounds = new kakao.maps.LatLngBounds();
            data.forEach((place) => {
                bounds.extend(new kakao.maps.LatLng(place.y, place.x));
            });
            map.setBounds(bounds);
            
            // TOP 3 ë§›ì§‘ í‘œì‹œ
            displayTop3Restaurants(data);
            
            // ë§ˆì»¤ í‘œì‹œ
            data.forEach(displayMarker);
        }

        // ============================================
        // ë§ˆì»¤ í‘œì‹œ
        // ============================================
        function displayMarker(place) {
            const marker = new kakao.maps.Marker({
                map,
                position: new kakao.maps.LatLng(place.y, place.x)
            });
            
            markers.push(marker);
            
            // ë§ˆì»¤ í´ë¦­ ì´ë²¤íŠ¸
            kakao.maps.event.addListener(marker, "click", () => {
                // ì¸í¬ìœˆë„ìš° í‘œì‹œ
                const content = `
                    <div style="padding:8px;font-size:12px;line-height:1.4;">
                        <strong>${place.place_name}</strong><br>
                        <span style="color:#666;">${place.road_address_name || place.address_name}</span>
                    </div>
                `;
                infowindow.setContent(content);
                infowindow.open(map, marker);
                
                // ì˜¤ë¥¸ìª½ ì„¸ë¶€ì •ë³´ ì˜ì—­ì— ìƒì„¸ ì •ë³´ í‘œì‹œ
                showDetail(place);
            });
        }

        // ============================================
        // ê¸°ì¡´ ë§ˆì»¤ë“¤ ì œê±°
        // ============================================
        function clearMarkers() {
            markers.forEach((marker) => marker.setMap(null));
            markers = [];
            document.getElementById("restaurant-list").innerHTML = "";
            resetDetailInfo();
        }

        // ============================================
        // TOP 3 ë§›ì§‘ í‘œì‹œ
        // ============================================
        function displayTop3Restaurants(places) {
            const list = document.getElementById("restaurant-list");
            list.innerHTML = "";

            const top3 = places.slice(0, 3);
            
            top3.forEach((place, index) => {
                const card = document.createElement("div");
                card.className = "restaurant-card";
                card.innerHTML = `
                    <h4>${index + 1}ìœ„. ${place.place_name}</h4>
                    <p>${place.road_address_name || place.address_name}</p>
                    <p class="rating">â­ ${(4 + Math.random()).toFixed(1)}</p>
                `;
                
                // ì¹´ë“œ í´ë¦­ ì´ë²¤íŠ¸
                card.addEventListener("click", () => showDetail(place));
                list.appendChild(card);
            });
        }

        // ============================================
        // ë§›ì§‘ ìƒì„¸ ì •ë³´ í‘œì‹œ (ì˜¤ë¥¸ìª½ ì˜ì—­)
        // ============================================
        function showDetail(place) {
            const detailContent = document.getElementById("restaurant-detail-content");
            const distance = calculateDistance(userLocation.lat, userLocation.lng, place.y, place.x);
            const distanceText = distance < 1000 ? Math.round(distance) + 'm' : (distance/1000).toFixed(1) + 'km';
            const rating = (4 + Math.random()).toFixed(1);
            const stars = 'â­'.repeat(Math.floor(rating));
            
            // ì˜ì—…ì‹œê°„ ëœë¤ ìƒì„± (í˜„ì‹¤ì ì¸ ì‹œê°„ëŒ€)
            const openTime = Math.floor(Math.random() * 3) + 7; // 7-9ì‹œ
            const closeTime = Math.floor(Math.random() * 4) + 21; // 21-24ì‹œ
            const businessHours = `${openTime.toString().padStart(2, '0')}:00 - ${closeTime.toString().padStart(2, '0')}:00`;
            
            // ê°€ê²©ëŒ€ ëœë¤ ìƒì„±
            const priceRanges = ['â‚©â‚© (1ë§Œì› ì´í•˜)', 'â‚©â‚©â‚© (1-3ë§Œì›)', 'â‚©â‚©â‚©â‚© (3-5ë§Œì›)', 'â‚©â‚©â‚©â‚©â‚© (5ë§Œì› ì´ìƒ)'];
            const priceRange = priceRanges[Math.floor(Math.random() * priceRanges.length)];
            
            // ì¸ê¸°ë„/ë¦¬ë·° ìˆ˜ ëœë¤ ìƒì„±
            const reviewCount = Math.floor(Math.random() * 500) + 10;
            const popularity = Math.floor(Math.random() * 100) + 1;
            
            // ì£¼ì°¨ ê°€ëŠ¥ ì—¬ë¶€
            const hasParking = Math.random() > 0.3 ? 'ê°€ëŠ¥' : 'ë¶ˆê°€ëŠ¥';
            
            // ì˜ˆì•½ ê°€ëŠ¥ ì—¬ë¶€
            const isReservable = Math.random() > 0.4 ? 'ê°€ëŠ¥' : 'ë¶ˆê°€ëŠ¥';
            
            detailContent.innerHTML = `
                <div class="restaurant-detail-card">
                    <h4>${place.place_name}</h4>
                    <div class="info-section">
                        <div class="info-row">
                            <span class="info-label">ğŸ“ ì£¼ì†Œ</span>
                            <span class="info-value">${place.road_address_name || place.address_name}</span>
                        </div>
                        
                        <div class="info-row">
                            <span class="info-label">ğŸ“ ì „í™”ë²ˆí˜¸</span>
                            <span class="info-value">${place.phone || "ì •ë³´ ì—†ìŒ"}</span>
                        </div>
                        
                        <div class="info-row">
                            <span class="info-label">ğŸ· ì¹´í…Œê³ ë¦¬</span>
                            <span class="info-value">${place.category_name || "ìŒì‹ì "}</span>
                        </div>
                        
                        <div class="info-row">
                            <span class="info-label">ğŸŒ ê±°ë¦¬</span>
                            <span class="info-value">
                                ì•½ ${distanceText}
                                <div class="distance-info">ë„ë³´ ${Math.ceil(distance/80)}ë¶„, ìë™ì°¨ ${Math.ceil(distance/1000)}ë¶„</div>
                            </span>
                        </div>
                        
                        <div class="info-row">
                            <span class="info-label">â­ í‰ì </span>
                            <span class="info-value">
                                ${rating} ${stars}
                                <div class="distance-info">ë¦¬ë·° ${reviewCount}ê°œ</div>
                            </span>
                        </div>
                        
                        <div class="info-row">
                            <span class="info-label">ğŸ•’ ì˜ì—…ì‹œê°„</span>
                            <span class="info-value">${businessHours}</span>
                        </div>
                        
                        <div class="info-row">
                            <span class="info-label">ğŸ’° ê°€ê²©ëŒ€</span>
                            <span class="info-value">${priceRange}</span>
                        </div>
                        
                        <div class="info-row">
                            <span class="info-label">ğŸš— ì£¼ì°¨</span>
                            <span class="info-value">${hasParking}</span>
                        </div>
                        
                        <div class="info-row">
                            <span class="info-label">ğŸ“… ì˜ˆì•½</span>
                            <span class="info-value">${isReservable}</span>
                        </div>
                        
                        <div class="info-row">
                            <span class="info-label">ğŸ”¥ ì¸ê¸°ë„</span>
                            <span class="info-value">${popularity}% (ì´ ì§€ì—­ ìƒìœ„)</span>
                        </div>
                        
                        <div class="additional-info">
                            <h5>ğŸ’¡ ì¶”ê°€ ì •ë³´</h5>
                            <div class="info-value">
                                â€¢ ${place.category_name ? place.category_name + ' ì „ë¬¸ì ' : 'ë‹¤ì–‘í•œ ë©”ë‰´ ì œê³µ'}<br>
                                â€¢ ${hasParking === 'ê°€ëŠ¥' ? 'ì£¼ì°¨ ê³µê°„ í™•ë³´' : 'ëŒ€ì¤‘êµí†µ ì´ìš© ê¶Œì¥'}<br>
                                â€¢ ${isReservable === 'ê°€ëŠ¥' ? 'ì‚¬ì „ ì˜ˆì•½ ê°€ëŠ¥' : 'í˜„ì¥ ëŒ€ê¸°'}<br>
                                â€¢ í‰ì¼/ì£¼ë§ ì˜ì—…ì‹œê°„ ë™ì¼
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // ============================================
        // ì„¸ë¶€ì •ë³´ ì˜ì—­ ì´ˆê¸°í™”
        // ============================================
        function resetDetailInfo() {
            const detailContent = document.getElementById("restaurant-detail-content");
            detailContent.innerHTML = '<p class="no-selection">ì§€ë„ì—ì„œ ìŒì‹ì ì„ í´ë¦­í•˜ë©´ ìƒì„¸ì •ë³´ê°€ í‘œì‹œë©ë‹ˆë‹¤</p>';
        }

        // ============================================
        // ë‘ ì¢Œí‘œ ê°„ì˜ ê±°ë¦¬ ê³„ì‚° (Haversine ê³µì‹)
        // ============================================
        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371; // ì§€êµ¬ì˜ ë°˜ì§€ë¦„ (km)
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            const distance = R * c * 1000; // ë¯¸í„° ë‹¨ìœ„ë¡œ ë³€í™˜
            return distance;
        }

        // ============================================
        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        // ============================================
        function setupEventListeners() {
            const searchBtn = document.getElementById("search-btn");
            const searchInput = document.getElementById("search-input");

            // ê²€ìƒ‰ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
            searchBtn.addEventListener("click", () => {
                const keyword = searchInput.value.trim();
                if (keyword) {
                    searchPlaces(keyword);
                } else {
                    alert("ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!");
                }
            });

            // ì—”í„°í‚¤ ì´ë²¤íŠ¸
            searchInput.addEventListener("keypress", (e) => {
                if (e.key === "Enter") {
                    const keyword = searchInput.value.trim();
                    if (keyword) {
                        searchPlaces(keyword);
                    } else {
                        alert("ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!");
                    }
                }
            });
        }

        // ============================================
        // URL íŒŒë¼ë¯¸í„°ì—ì„œ ê²€ìƒ‰ì–´ ì¶”ì¶œ
        // ============================================
        function getSearchParamFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const searchParam = urlParams.get('search');
            console.log('URL íŒŒë¼ë¯¸í„° í™•ì¸:', window.location.search);
            console.log('ê²€ìƒ‰ì–´:', searchParam);
            return searchParam;
        }

        // ============================================
        // ì¹´ì¹´ì˜¤ API ë¡œë“œ ì™„ë£Œ í›„ ì‹¤í–‰í•  ì´ˆê¸°í™” í•¨ìˆ˜
        // ============================================
        async function initializeMapAfterKakaoLoad() {
            console.log('ğŸ“„ ì¹´ì¹´ì˜¤ API ë¡œë“œ ì™„ë£Œ, ì´ˆê¸°í™” ì‹œì‘');
            
            try {
                // 0. InfoWindow ì´ˆê¸°í™” (ì¹´ì¹´ì˜¤ API ë¡œë“œ í›„ì—ë§Œ ê°€ëŠ¥)
                infowindow = new kakao.maps.InfoWindow({ zIndex: 1 });
                
                // 1. ì‚¬ìš©ì ìœ„ì¹˜ ê°€ì ¸ì˜¤ê¸°
                await getUserLocation();
                
                // 2. ì§€ë„ ì´ˆê¸°í™”
                initMap();
                
                // 3. ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
                setupEventListeners();
                
                // 4. URLì—ì„œ ê²€ìƒ‰ì–´ê°€ ìˆìœ¼ë©´ ìë™ ê²€ìƒ‰ ì‹¤í–‰
                const searchParam = getSearchParamFromURL();
                if (searchParam) {
                    console.log('ğŸ” ìë™ ê²€ìƒ‰ ì‹¤í–‰:', searchParam);
                    // ê²€ìƒ‰ ì…ë ¥ì°½ì— ê°’ ì„¤ì •
                    document.getElementById('search-input').value = searchParam;
                    // ìë™ ê²€ìƒ‰ ì‹¤í–‰
                    searchPlaces(searchParam);
                }
                
            } catch (error) {
                console.error('âŒ ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
                alert('ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ============================================
        // í˜ì´ì§€ ë¡œë“œ í›„ ì‹¤í–‰ (ì¹´ì¹´ì˜¤ APIì™€ ë¬´ê´€í•œ ê¸°ë³¸ ì„¤ì •)
        // ============================================
        window.onload = () => {
            console.log('ğŸ“„ í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ');
            // ì¹´ì¹´ì˜¤ API ë¡œë“œê°€ ì™„ë£Œë˜ë©´ initializeMapAfterKakaoLoad()ê°€ í˜¸ì¶œë©ë‹ˆë‹¤
        };
    </script>
</body>
</html>