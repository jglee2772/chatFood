<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>맛집 지도 - LunchBot</title>
    <link rel="stylesheet" href="/css/foodMap.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700;800&display=swap" rel="stylesheet">
</head>

<body>
    <!-- 🏠 헤더 영역 -->
    <header>
        <h1>🍱 LunchBot 맛집 지도</h1>
        <p>AI가 내 주변 맛집을 찾아드릴게요</p>
        
        <!-- 🔍 검색창 -->
        <div class="search-box">
            <input type="text" id="search-input" placeholder="예: 초밥, 돈까스, 파스타">
            <button id="search-btn">검색</button>
        </div>
    </header>

    <!-- 📱 메인 콘텐츠 -->
    <div class="main-wrapper">
        <!-- 🗺️ 지도 영역 -->
        <div class="upper-content">
            <div id="map"></div>
            <div class="map-title">📍 내 주변 맛집 탐색 중...</div>
        </div>

        <!-- 📋 맛집 세부정보 영역 -->
        <div class="detail-section">
            <h3>🍽️ 맛집 상세정보</h3>
            <div id="restaurant-detail-info">
                <div id="restaurant-detail-content">
                    <p class="no-selection">지도에서 음식점을 클릭하면 상세정보가 표시됩니다</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 🏆 추천 맛집 TOP 3 (하단 가로 배치) -->
    <div class="recommended-section">
        <h3>🏆 AI 추천 맛집 TOP 3</h3>
        <div id="restaurant-list" class="restaurant-list-horizontal"></div>
    </div>

    <!-- 📚 카카오 지도 API -->
    <!-- 환경 변수에서 API 키를 동적으로 로드 -->
    <script th:inline="javascript">
        /*<![CDATA[*/
        // 카카오 API 초기화 함수
        function initializeKakaoAPI() {
            // 서버에서 전달받은 카카오 API 키 사용
            const kakaoApiKey = /*[[${kakaoApiKey}]]*/ '';
            
            console.log('🔑 카카오 API 키 확인:', kakaoApiKey);
            
            // API 키가 비어있으면 에러 처리
            if (!kakaoApiKey || kakaoApiKey.trim() === '') {
                console.error('❌ 카카오 API 키가 설정되지 않았습니다.');
                alert('카카오 지도 API 키가 설정되지 않았습니다. 관리자에게 문의해주세요.');
                return;
            }
            
            const finalApiKey = kakaoApiKey;
            console.log('🔑 최종 사용할 API 키:', finalApiKey);
            
            // 카카오 지도 API 동적 로드
            const script = document.createElement('script');
            script.src = `//dapi.kakao.com/v2/maps/sdk.js?appkey=${finalApiKey}&libraries=services`;
            script.async = true;
            
            // 카카오 API 로드 완료 후 콜백 함수 설정
            script.onload = function() {
                console.log('✅ 카카오 API 로드 완료');
                // API 로드 완료 후 초기화 함수 호출
                initializeMapAfterKakaoLoad();
            };
            
            script.onerror = function() {
                console.error('❌ 카카오 API 로드 실패');
                console.error('사용된 API 키:', finalApiKey);
                console.error('현재 도메인:', window.location.hostname);
                console.error('현재 프로토콜:', window.location.protocol);
                
                // 대체 로딩 방식 시도 (HTTPS/HTTP)
                console.log('🔄 대체 로딩 방식 시도 중...');
                const alternativeScript = document.createElement('script');
                const alternativeUrl = window.location.protocol === 'https:' 
                    ? `https://dapi.kakao.com/v2/maps/sdk.js?appkey=${finalApiKey}&libraries=services`
                    : `http://dapi.kakao.com/v2/maps/sdk.js?appkey=${finalApiKey}&libraries=services`;
                
                alternativeScript.src = alternativeUrl;
                alternativeScript.async = true;
                
                alternativeScript.onload = function() {
                    console.log('✅ 대체 방식으로 카카오 API 로드 성공');
                    initializeMapAfterKakaoLoad();
                };
                
                alternativeScript.onerror = function() {
                    console.error('❌ 대체 방식도 실패');
                    
                    // 지도 영역에 에러 메시지 표시
                    const mapContainer = document.getElementById('map');
                    if (mapContainer) {
                        mapContainer.innerHTML = `
                            <div style="display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100%; background: #f5f5f5; border-radius: 8px; padding: 20px; text-align: center;">
                                <div style="font-size: 48px; margin-bottom: 16px;">🗺️</div>
                                <h3 style="color: #666; margin-bottom: 8px;">지도를 불러올 수 없습니다</h3>
                                <p style="color: #999; font-size: 14px;">카카오 지도 API 설정을 확인해주세요.</p>
                                <p style="color: #999; font-size: 12px; margin-top: 8px;">
                                    도메인: ${window.location.hostname}<br>
                                    프로토콜: ${window.location.protocol}
                                </p>
                                <button onclick="location.reload()" style="margin-top: 16px; padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">새로고침</button>
                            </div>
                        `;
                    }
                    
                    // 검색 기능 비활성화
                    const searchInput = document.getElementById('search-input');
                    const searchBtn = document.getElementById('search-btn');
                    if (searchInput) searchInput.disabled = true;
                    if (searchBtn) searchBtn.disabled = true;
                };
                
                document.head.appendChild(alternativeScript);
            };
            
            document.head.appendChild(script);
        }
        
        // 페이지 로드 시 카카오 API 초기화 실행
        initializeKakaoAPI();
        /*]]>*/
    </script>
    <!-- 🏠 홈 버튼 -->
    <div class="home-btn" onclick="window.location.href='/'">🏠</div>

    <!-- 🚀 JavaScript 코드 -->
    <script>
        // ============================================
        // 전역 변수
        // ============================================
        let map;
        let userLocation = null;
        let markers = [];
        let infowindow;

        // ============================================
        // 사용자 현재 위치 가져오기
        // ============================================
        async function getUserLocation() {
            return new Promise((resolve) => {
                if (!navigator.geolocation) {
                    console.warn('⚠️ Geolocation을 지원하지 않는 브라우저입니다.');
                    userLocation = { lat: 37.5665, lng: 126.9780 }; // 서울 시청
                    resolve();
                    return;
                }

                console.log('📍 현재 위치를 가져오는 중...');

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        console.log('✅ 현재 위치:', userLocation);
                        resolve();
                    },
                    (error) => {
                        console.warn('⚠️ 위치 권한 거부 또는 오류:', error.message);
                        userLocation = { lat: 37.5665, lng: 126.9780 }; // 서울 시청
                        resolve();
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            });
        }

        // ============================================
        // 지도 초기화
        // ============================================
        function initMap() {
            console.log('🗺️ 지도 초기화 시작');
            
            try {
                const center = new kakao.maps.LatLng(userLocation.lat, userLocation.lng);
                const container = document.getElementById("map");
                const options = { 
                    center, 
                    level: 5 
                };
                
                map = new kakao.maps.Map(container, options);
                
                // 내 위치 마커 추가
                const marker = new kakao.maps.Marker({ 
                    position: center, 
                    map 
                });
                
                const info = new kakao.maps.InfoWindow({
                    content: '<div style="padding:5px;font-size:12px;">📍 내 위치</div>'
                });
                info.open(map, marker);
                
                console.log('✅ 지도 초기화 완료');
                
                // 기본 맛집 검색
                searchPlaces("맛집");
                
            } catch (error) {
                console.error('❌ 지도 초기화 실패:', error);
                alert('지도 초기화 실패: ' + error.message);
            }
        }

        // ============================================
        // 장소 검색
        // ============================================
        function searchPlaces(keyword) {
            console.log('🔍 검색 시작:', keyword);
            
            if (!userLocation) {
                alert('📍 위치 정보가 없습니다. 위치 권한을 허용해주세요.');
                return;
            }
            
            // 기존 마커들 제거
            clearMarkers();
            
            // 장소 검색 서비스 객체 생성
            const ps = new kakao.maps.services.Places();
            
            // 검색 옵션 설정 (내 위치 기준 2km 반경)
            const options = {
                location: new kakao.maps.LatLng(userLocation.lat, userLocation.lng),
                radius: 2000, // 2km 반경
                sort: kakao.maps.services.SortBy.DISTANCE // 거리순 정렬
            };
            
            // 키워드로 장소 검색
            ps.keywordSearch(keyword, placesSearchCB, options);
        }

        // ============================================
        // 검색 결과 처리
        // ============================================
        function placesSearchCB(data, status) {
            if (status !== kakao.maps.services.Status.OK) {
                console.warn('⚠️ 검색 실패:', status);
                alert('검색 결과가 없습니다. 다른 키워드로 시도해보세요.');
                return;
            }

            console.log('✅ 검색 결과:', data.length + '개');
            
            // 검색된 장소 위치를 기준으로 지도 범위 재설정
            const bounds = new kakao.maps.LatLngBounds();
            data.forEach((place) => {
                bounds.extend(new kakao.maps.LatLng(place.y, place.x));
            });
            map.setBounds(bounds);
            
            // TOP 3 맛집 표시
            displayTop3Restaurants(data);
            
            // 마커 표시
            data.forEach(displayMarker);
        }

        // ============================================
        // 마커 표시
        // ============================================
        function displayMarker(place) {
            const marker = new kakao.maps.Marker({
                map,
                position: new kakao.maps.LatLng(place.y, place.x)
            });
            
            markers.push(marker);
            
            // 마커 클릭 이벤트
            kakao.maps.event.addListener(marker, "click", () => {
                // 인포윈도우 표시
                const content = `
                    <div style="padding:8px;font-size:12px;line-height:1.4;">
                        <strong>${place.place_name}</strong><br>
                        <span style="color:#666;">${place.road_address_name || place.address_name}</span>
                    </div>
                `;
                infowindow.setContent(content);
                infowindow.open(map, marker);
                
                // 오른쪽 세부정보 영역에 상세 정보 표시
                showDetail(place);
            });
        }

        // ============================================
        // 기존 마커들 제거
        // ============================================
        function clearMarkers() {
            markers.forEach((marker) => marker.setMap(null));
            markers = [];
            document.getElementById("restaurant-list").innerHTML = "";
            resetDetailInfo();
        }

        // ============================================
        // TOP 3 맛집 표시
        // ============================================
        function displayTop3Restaurants(places) {
            const list = document.getElementById("restaurant-list");
            list.innerHTML = "";

            const top3 = places.slice(0, 3);
            
            top3.forEach((place, index) => {
                const card = document.createElement("div");
                card.className = "restaurant-card";
                card.innerHTML = `
                    <h4>${index + 1}위. ${place.place_name}</h4>
                    <p>${place.road_address_name || place.address_name}</p>
                    <p class="rating">⭐ ${(4 + Math.random()).toFixed(1)}</p>
                `;
                
                // 카드 클릭 이벤트
                card.addEventListener("click", () => showDetail(place));
                list.appendChild(card);
            });
        }

        // ============================================
        // 맛집 상세 정보 표시 (오른쪽 영역)
        // ============================================
        function showDetail(place) {
            const detailContent = document.getElementById("restaurant-detail-content");
            const distance = calculateDistance(userLocation.lat, userLocation.lng, place.y, place.x);
            const distanceText = distance < 1000 ? Math.round(distance) + 'm' : (distance/1000).toFixed(1) + 'km';
            const rating = (4 + Math.random()).toFixed(1);
            const stars = '⭐'.repeat(Math.floor(rating));
            
            // 영업시간 랜덤 생성 (현실적인 시간대)
            const openTime = Math.floor(Math.random() * 3) + 7; // 7-9시
            const closeTime = Math.floor(Math.random() * 4) + 21; // 21-24시
            const businessHours = `${openTime.toString().padStart(2, '0')}:00 - ${closeTime.toString().padStart(2, '0')}:00`;
            
            // 가격대 랜덤 생성
            const priceRanges = ['₩₩ (1만원 이하)', '₩₩₩ (1-3만원)', '₩₩₩₩ (3-5만원)', '₩₩₩₩₩ (5만원 이상)'];
            const priceRange = priceRanges[Math.floor(Math.random() * priceRanges.length)];
            
            // 인기도/리뷰 수 랜덤 생성
            const reviewCount = Math.floor(Math.random() * 500) + 10;
            const popularity = Math.floor(Math.random() * 100) + 1;
            
            // 주차 가능 여부
            const hasParking = Math.random() > 0.3 ? '가능' : '불가능';
            
            // 예약 가능 여부
            const isReservable = Math.random() > 0.4 ? '가능' : '불가능';
            
            detailContent.innerHTML = `
                <div class="restaurant-detail-card">
                    <h4>${place.place_name}</h4>
                    <div class="info-section">
                        <div class="info-row">
                            <span class="info-label">📍 주소</span>
                            <span class="info-value">${place.road_address_name || place.address_name}</span>
                        </div>
                        
                        <div class="info-row">
                            <span class="info-label">📞 전화번호</span>
                            <span class="info-value">${place.phone || "정보 없음"}</span>
                        </div>
                        
                        <div class="info-row">
                            <span class="info-label">🏷 카테고리</span>
                            <span class="info-value">${place.category_name || "음식점"}</span>
                        </div>
                        
                        <div class="info-row">
                            <span class="info-label">🌐 거리</span>
                            <span class="info-value">
                                약 ${distanceText}
                                <div class="distance-info">도보 ${Math.ceil(distance/80)}분, 자동차 ${Math.ceil(distance/1000)}분</div>
                            </span>
                        </div>
                        
                        <div class="info-row">
                            <span class="info-label">⭐ 평점</span>
                            <span class="info-value">
                                ${rating} ${stars}
                                <div class="distance-info">리뷰 ${reviewCount}개</div>
                            </span>
                        </div>
                        
                        <div class="info-row">
                            <span class="info-label">🕒 영업시간</span>
                            <span class="info-value">${businessHours}</span>
                        </div>
                        
                        <div class="info-row">
                            <span class="info-label">💰 가격대</span>
                            <span class="info-value">${priceRange}</span>
                        </div>
                        
                        <div class="info-row">
                            <span class="info-label">🚗 주차</span>
                            <span class="info-value">${hasParking}</span>
                        </div>
                        
                        <div class="info-row">
                            <span class="info-label">📅 예약</span>
                            <span class="info-value">${isReservable}</span>
                        </div>
                        
                        <div class="info-row">
                            <span class="info-label">🔥 인기도</span>
                            <span class="info-value">${popularity}% (이 지역 상위)</span>
                        </div>
                        
                        <div class="additional-info">
                            <h5>💡 추가 정보</h5>
                            <div class="info-value">
                                • ${place.category_name ? place.category_name + ' 전문점' : '다양한 메뉴 제공'}<br>
                                • ${hasParking === '가능' ? '주차 공간 확보' : '대중교통 이용 권장'}<br>
                                • ${isReservable === '가능' ? '사전 예약 가능' : '현장 대기'}<br>
                                • 평일/주말 영업시간 동일
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // ============================================
        // 세부정보 영역 초기화
        // ============================================
        function resetDetailInfo() {
            const detailContent = document.getElementById("restaurant-detail-content");
            detailContent.innerHTML = '<p class="no-selection">지도에서 음식점을 클릭하면 상세정보가 표시됩니다</p>';
        }

        // ============================================
        // 두 좌표 간의 거리 계산 (Haversine 공식)
        // ============================================
        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371; // 지구의 반지름 (km)
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            const distance = R * c * 1000; // 미터 단위로 변환
            return distance;
        }

        // ============================================
        // 이벤트 리스너 설정
        // ============================================
        function setupEventListeners() {
            const searchBtn = document.getElementById("search-btn");
            const searchInput = document.getElementById("search-input");

            // 검색 버튼 클릭 이벤트
            searchBtn.addEventListener("click", () => {
                const keyword = searchInput.value.trim();
                if (keyword) {
                    searchPlaces(keyword);
                } else {
                    alert("검색어를 입력해주세요!");
                }
            });

            // 엔터키 이벤트
            searchInput.addEventListener("keypress", (e) => {
                if (e.key === "Enter") {
                    const keyword = searchInput.value.trim();
                    if (keyword) {
                        searchPlaces(keyword);
                    } else {
                        alert("검색어를 입력해주세요!");
                    }
                }
            });
        }

        // ============================================
        // URL 파라미터에서 검색어 추출
        // ============================================
        function getSearchParamFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const searchParam = urlParams.get('search');
            console.log('URL 파라미터 확인:', window.location.search);
            console.log('검색어:', searchParam);
            return searchParam;
        }

        // ============================================
        // 카카오 API 로드 완료 후 실행할 초기화 함수
        // ============================================
        async function initializeMapAfterKakaoLoad() {
            console.log('📄 카카오 API 로드 완료, 초기화 시작');
            
            try {
                // 0. InfoWindow 초기화 (카카오 API 로드 후에만 가능)
                infowindow = new kakao.maps.InfoWindow({ zIndex: 1 });
                
                // 1. 사용자 위치 가져오기
                await getUserLocation();
                
                // 2. 지도 초기화
                initMap();
                
                // 3. 이벤트 리스너 설정
                setupEventListeners();
                
                // 4. URL에서 검색어가 있으면 자동 검색 실행
                const searchParam = getSearchParamFromURL();
                if (searchParam) {
                    console.log('🔍 자동 검색 실행:', searchParam);
                    // 검색 입력창에 값 설정
                    document.getElementById('search-input').value = searchParam;
                    // 자동 검색 실행
                    searchPlaces(searchParam);
                }
                
            } catch (error) {
                console.error('❌ 초기화 오류:', error);
                alert('초기화 중 오류가 발생했습니다.');
            }
        }

        // ============================================
        // 페이지 로드 후 실행 (카카오 API와 무관한 기본 설정)
        // ============================================
        window.onload = () => {
            console.log('📄 페이지 로드 완료');
            // 카카오 API 로드가 완료되면 initializeMapAfterKakaoLoad()가 호출됩니다
        };
    </script>
</body>
</html>